<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>AiaxStock – Owner Stock Panel</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    :root {
      font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
      --pastel-pink: #ffd6e7;
      --pastel-blue: #d6e4ff;
      --pastel-lavender: #e6d6ff;
      --pastel-mint: #d6ffe7;
      --pastel-peach: #ffd6cc;
      --pastel-cream: #fff9f0;
      --pastel-gray: #f5f5f8;
      --pastel-lilac: #f0e6ff;
      --pastel-rose: #ffe6f2;
      --pastel-sky: #e6f7ff;
      --text-dark: #333344;
      --text-medium: #666677;
      --text-light: #888899;
      --primary: #ff85b3;
      --secondary: #85a3ff;
      --success: #5cd6a9;
      --warning: #ffb366;
      --danger: #ff6666;
      --border-radius: 16px;
      --shadow: 0 8px 32px rgba(0, 0, 0, 0.08);
      --transition: all 0.3s ease;
    }
    
    * {
      box-sizing: border-box;
    }
    
    body {
      margin: 0;
      background: linear-gradient(135deg, var(--pastel-lilac) 0%, var(--pastel-sky) 100%);
      color: var(--text-dark);
      min-height: 100vh;
      padding: 0;
    }
    
    /* MOBILE FIRST DESIGN */
    .mobile-header {
      display: none;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      padding: 1rem;
      box-shadow: var(--shadow);
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 1000;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid rgba(255, 214, 231, 0.5);
    }
    
    .menu-toggle {
      background: var(--pastel-pink);
      border: none;
      font-size: 1.2rem;
      color: var(--text-dark);
      cursor: pointer;
      padding: 0.5rem;
      width: 40px;
      height: 40px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .brand-mobile {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }
    
    .brand-icon {
      width: 40px;
      height: 40px;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 1.2rem;
      box-shadow: 0 4px 12px rgba(255, 133, 179, 0.3);
    }
    
    .brand-text h1 {
      margin: 0;
      font-size: 1.1rem;
      font-weight: 700;
      color: var(--text-dark);
    }
    
    .brand-text p {
      margin: 0;
      font-size: 0.75rem;
      color: var(--text-light);
    }
    
    /* Mobile sidebar overlay */
    .sidebar-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.3);
      z-index: 1000;
      backdrop-filter: blur(4px);
    }
    
    .sidebar-overlay.active {
      display: block;
    }
    
    /* SIDEBAR */
    .sidebar {
      position: fixed;
      left: 0;
      top: 0;
      bottom: 0;
      width: 280px;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      padding: 1.5rem;
      box-shadow: var(--shadow);
      z-index: 1001;
      overflow-y: auto;
      transform: translateX(-100%);
      transition: transform 0.3s ease;
      border-right: 1px solid rgba(255, 214, 231, 0.5);
    }
    
    .sidebar.active {
      transform: translateX(0);
    }
    
    .sidebar-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 2rem;
      padding-bottom: 1rem;
      border-bottom: 2px solid var(--pastel-pink);
    }
    
    .close-sidebar {
      background: var(--pastel-gray);
      border: none;
      font-size: 1.2rem;
      color: var(--text-dark);
      cursor: pointer;
      padding: 0.5rem;
      width: 40px;
      height: 40px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    /* MAIN CONTENT */
    .main-content {
      padding: 1rem;
      margin-top: 0;
      width: 100%;
      min-height: 100vh;
    }
    
    /* Content panels */
    .content-panel {
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(10px);
      border-radius: var(--border-radius);
      padding: 1.5rem;
      box-shadow: var(--shadow);
      margin-bottom: 1.5rem;
      display: none;
      border: 1px solid rgba(255, 255, 255, 0.5);
    }
    
    .content-panel.active {
      display: block;
      animation: fadeIn 0.5s ease;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .panel-header {
      display: flex;
      flex-direction: column;
      gap: 1rem;
      margin-bottom: 1.5rem;
      padding-bottom: 1rem;
      border-bottom: 2px solid var(--pastel-pink);
    }
    
    @media (min-width: 768px) {
      .panel-header {
        flex-direction: row;
        justify-content: space-between;
        align-items: center;
      }
    }
    
    .panel-header h3 {
      margin: 0;
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--text-dark);
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .panel-header h3 i {
      color: var(--primary);
    }
    
    .panel-actions {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }
    
    /* FORMS */
    .form-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 1.2rem;
      margin-bottom: 1.5rem;
    }
    
    @media (min-width: 768px) {
      .form-grid {
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      }
    }
    
    .form-group {
      margin-bottom: 0.5rem;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 600;
      color: var(--text-medium);
      font-size: 0.9rem;
      padding-left: 0.5rem;
    }
    
    .form-control {
      width: 100%;
      padding: 0.85rem 1rem;
      border: 2px solid var(--pastel-pink);
      border-radius: 12px;
      font-size: 0.95rem;
      color: var(--text-dark);
      background: white;
      transition: var(--transition);
    }
    
    .form-control:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(255, 133, 179, 0.2);
    }
    
    .form-control::placeholder {
      color: var(--text-light);
    }
    
    /* BUTTONS */
    .btn {
      padding: 0.85rem 1.5rem;
      border: none;
      border-radius: 12px;
      font-size: 0.95rem;
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      width: 100%;
      margin-bottom: 0.5rem;
    }
    
    @media (min-width: 480px) {
      .btn {
        width: auto;
        margin-bottom: 0;
      }
    }
    
    .btn-primary {
      background: linear-gradient(135deg, var(--primary), #ff66a3);
      color: white;
      box-shadow: 0 4px 12px rgba(255, 133, 179, 0.3);
    }
    
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(255, 133, 179, 0.4);
    }
    
    .btn-secondary {
      background: var(--pastel-blue);
      color: var(--text-dark);
      border: 1px solid rgba(133, 163, 255, 0.3);
    }
    
    .btn-secondary:hover {
      background: var(--secondary);
      color: white;
      transform: translateY(-2px);
    }
    
    .btn-success {
      background: var(--success);
      color: white;
      box-shadow: 0 4px 12px rgba(92, 214, 169, 0.3);
    }
    
    .btn-sm {
      padding: 0.5rem 1rem;
      font-size: 0.85rem;
    }
    
    .btn-full {
      width: 100%;
    }
    
    /* FILTERS */
    .filters-row {
      display: grid;
      grid-template-columns: 1fr;
      gap: 1rem;
      margin-bottom: 1.5rem;
      padding: 1rem;
      background: rgba(255, 255, 255, 0.7);
      border-radius: 12px;
      border: 1px solid var(--pastel-pink);
    }
    
    @media (min-width: 768px) {
      .filters-row {
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      }
    }
    
    .filter-group {
      display: flex;
      flex-direction: column;
    }
    
    /* TABLES */
    .table-container {
      overflow-x: auto;
      border-radius: 12px;
      border: 1px solid var(--pastel-pink);
      margin-bottom: 1rem;
      background: white;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    }
    
    .table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.85rem;
      min-width: 600px;
    }
    
    .table th {
      background: var(--pastel-pink);
      padding: 1rem;
      text-align: left;
      font-weight: 600;
      color: var(--text-dark);
      border-bottom: 2px solid var(--pastel-pink);
      white-space: nowrap;
    }
    
    .table td {
      padding: 1rem;
      border-bottom: 1px solid var(--pastel-gray);
      color: var(--text-dark);
      word-break: break-word;
    }
    
    .table tr:hover {
      background: rgba(255, 214, 231, 0.1);
    }
    
    .table tr:last-child td {
      border-bottom: none;
    }
    
    /* BADGES */
    .badge {
      display: inline-block;
      padding: 0.3rem 0.8rem;
      border-radius: 20px;
      font-size: 0.75rem;
      font-weight: 700;
      white-space: nowrap;
      letter-spacing: 0.3px;
    }
    
    .badge-auto {
      background: linear-gradient(135deg, rgba(133, 255, 189, 0.2), rgba(0, 200, 100, 0.1));
      color: #00a366;
      border: 1px solid rgba(0, 200, 100, 0.3);
    }
    
    .badge-manual {
      background: linear-gradient(135deg, rgba(255, 133, 179, 0.2), rgba(200, 0, 100, 0.1));
      color: #cc0066;
      border: 1px solid rgba(200, 0, 100, 0.3);
    }
    
    .badge-sold {
      background: linear-gradient(135deg, rgba(255, 179, 102, 0.2), rgba(204, 102, 0, 0.1));
      color: #cc6600;
      border: 1px solid rgba(204, 102, 0, 0.3);
    }
    
    .badge-available {
      background: linear-gradient(135deg, rgba(133, 163, 255, 0.2), rgba(51, 102, 255, 0.1));
      color: #3366ff;
      border: 1px solid rgba(51, 102, 255, 0.3);
    }
    
    .badge-quantity {
      background: linear-gradient(135deg, var(--primary), #ff66a3);
      color: white;
      font-size: 0.8rem;
      min-width: 25px;
      text-align: center;
    }
    
    /* STATS CARDS */
    .stats-cards {
      display: grid;
      grid-template-columns: 1fr;
      gap: 1rem;
      margin: 1.5rem 0;
    }
    
    @media (min-width: 480px) {
      .stats-cards {
        grid-template-columns: repeat(2, 1fr);
      }
    }
    
    @media (min-width: 768px) {
      .stats-cards {
        grid-template-columns: repeat(4, 1fr);
      }
    }
    
    .stat-card {
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(10px);
      border-radius: var(--border-radius);
      padding: 1.5rem;
      box-shadow: var(--shadow);
      display: flex;
      align-items: center;
      gap: 1rem;
      transition: var(--transition);
      border: 1px solid rgba(255, 255, 255, 0.5);
    }
    
    .stat-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 16px 32px rgba(0, 0, 0, 0.12);
    }
    
    .stat-icon {
      width: 50px;
      height: 50px;
      border-radius: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.3rem;
      color: white;
      flex-shrink: 0;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    
    .stat-icon.pink { 
      background: linear-gradient(135deg, #ff85b3, #ff66a3); 
    }
    .stat-icon.blue { 
      background: linear-gradient(135deg, #85a3ff, #668cff); 
    }
    .stat-icon.green { 
      background: linear-gradient(135deg, #5cd6a9, #33cc99); 
    }
    .stat-icon.purple { 
      background: linear-gradient(135deg, #b366ff, #9933ff); 
    }
    
    .stat-info h3 {
      margin: 0;
      font-size: 1.8rem;
      font-weight: 800;
      color: var(--text-dark);
      line-height: 1;
    }
    
    .stat-info p {
      margin: 0.5rem 0 0;
      font-size: 0.85rem;
      color: var(--text-light);
    }
    
    /* PRODUCT GROUPS */
    .product-group {
      background: rgba(255, 255, 255, 0.9);
      border-radius: 12px;
      margin-bottom: 1rem;
      overflow: hidden;
      border: 1px solid var(--pastel-pink);
    }
    
    .product-header {
      padding: 1rem;
      background: linear-gradient(135deg, rgba(255, 214, 231, 0.3), rgba(255, 214, 231, 0.1));
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      transition: var(--transition);
    }
    
    .product-header:hover {
      background: linear-gradient(135deg, rgba(255, 214, 231, 0.5), rgba(255, 214, 231, 0.2));
    }
    
    .product-header h4 {
      margin: 0;
      font-size: 1rem;
      color: var(--text-dark);
      font-weight: 600;
    }
    
    .product-count {
      background: var(--pastel-blue);
      color: var(--text-dark);
      padding: 0.3rem 0.8rem;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 700;
      flex-shrink: 0;
    }
    
    .product-body {
      padding: 1rem;
      display: none;
    }
    
    .product-body.open {
      display: block;
      animation: slideDown 0.3s ease;
    }
    
    @keyframes slideDown {
      from { opacity: 0; max-height: 0; }
      to { opacity: 1; max-height: 1000px; }
    }
    
   /* PIN GATE */
    #pin-gate {
      position: fixed;
      inset: 0;
      background: linear-gradient(135deg, var(--pastel-lilac), var(--pastel-sky));
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 2000;
      padding: 1rem;
    }
    
    .pin-container {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      padding: 2.5rem;
      border-radius: 24px;
      box-shadow: var(--shadow);
      width: 100%;
      max-width: 400px;
      text-align: center;
      border: 1px solid rgba(255, 255, 255, 0.5);
    }
    
    .pin-icon {
      font-size: 3rem;
      color: var(--primary);
      margin-bottom: 1.5rem;
      text-shadow: 0 4px 12px rgba(255, 133, 179, 0.3);
    }
    
    /* MESSAGES */
    .message {
      padding: 1rem;
      border-radius: 12px;
      margin: 1rem 0;
      font-weight: 500;
      font-size: 0.9rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      border-left: 4px solid transparent;
    }
    
    .message-success {
      background: linear-gradient(135deg, rgba(92, 214, 169, 0.2), rgba(0, 200, 100, 0.1));
      color: #006633;
      border-left-color: var(--success);
    }
    
    .message-error {
      background: linear-gradient(135deg, rgba(255, 102, 102, 0.2), rgba(200, 0, 0, 0.1));
      color: #cc0000;
      border-left-color: var(--danger);
    }
    
    .message-info {
      background: linear-gradient(135deg, rgba(133, 163, 255, 0.2), rgba(0, 100, 200, 0.1));
      color: #0033cc;
      border-left-color: var(--secondary);
    }
    
    /* SIDEBAR NAVIGATION */
    .nav-section {
      margin-bottom: 1.5rem;
    }
    
    .nav-section h3 {
      font-size: 0.8rem;
      text-transform: uppercase;
      color: var(--text-light);
      margin: 0 0 0.75rem 0;
      letter-spacing: 0.1em;
      font-weight: 600;
    }
    
    .nav-btn {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      width: 100%;
      padding: 0.85rem 1rem;
      background: transparent;
      border: none;
      border-radius: 12px;
      color: var(--text-medium);
      font-size: 0.95rem;
      text-align: left;
      cursor: pointer;
      transition: var(--transition);
      margin-bottom: 0.4rem;
    }
    
    .nav-btn:hover {
      background: var(--pastel-pink);
      color: var(--text-dark);
      transform: translateX(5px);
    }
    
    .nav-btn.active {
      background: linear-gradient(135deg, var(--pastel-pink), var(--pastel-lavender));
      color: var(--text-dark);
      font-weight: 700;
      box-shadow: 0 4px 12px rgba(255, 133, 179, 0.2);
      transform: translateX(5px);
    }
    
    .nav-btn i {
      width: 20px;
      font-size: 1rem;
      flex-shrink: 0;
    }
    
    /* STOCK GROUP ITEMS */
    .stock-group-item {
      background: white;
      border-radius: 12px;
      padding: 1rem;
      margin-bottom: 1rem;
      border: 1px solid var(--pastel-pink);
      transition: var(--transition);
    }
    
    .stock-group-item:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow);
    }
    
    .stock-group-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.5rem;
    }
    
    .stock-group-details {
      background: var(--pastel-gray);
      padding: 0.75rem;
      border-radius: 8px;
      font-size: 0.9rem;
    }
    
    .stock-group-actions {
      display: flex;
      gap: 0.5rem;
      margin-top: 0.75rem;
    }
    
    /* SOLD ACCOUNTS CARDS */
    .sold-cards-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 1rem;
      margin-top: 1rem;
    }
    
    .sold-card {
      background: white;
      border-radius: var(--border-radius);
      padding: 1.25rem;
      box-shadow: var(--shadow);
      border: 1px solid var(--pastel-pink);
      cursor: pointer;
      transition: var(--transition);
      position: relative;
    }
    
    .sold-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 12px 24px rgba(0, 0, 0, 0.1);
    }
    
    .sold-card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.75rem;
      padding-bottom: 0.75rem;
      border-bottom: 1px solid var(--pastel-gray);
    }
    
    .sold-card-details {
      font-size: 0.85rem;
      color: var(--text-medium);
    }
    
    .sold-card-details div {
      margin-bottom: 0.4rem;
      display: flex;
      justify-content: space-between;
    }
    
    .sold-card-details strong {
      color: var(--text-dark);
      min-width: 100px;
    }
    
    /* DETAIL OVERLAY */
    .detail-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(5px);
      z-index: 2000;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 1rem;
    }
    
    .detail-overlay.active {
      display: flex;
      animation: fadeIn 0.3s ease;
    }
    
    .detail-card {
      background: white;
      border-radius: var(--border-radius);
      padding: 2rem;
      max-width: 500px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: var(--shadow);
      position: relative;
    }
    
    .detail-close {
      position: absolute;
      top: 1rem;
      right: 1rem;
      background: var(--pastel-gray);
      border: none;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      color: var(--text-dark);
      transition: var(--transition);
    }
    
    .detail-close:hover {
      background: var(--pastel-pink);
    }
    
    .detail-section {
      margin-bottom: 1.5rem;
      padding-bottom: 1.5rem;
      border-bottom: 1px solid var(--pastel-gray);
    }
    
    .detail-section:last-child {
      border-bottom: none;
      margin-bottom: 0;
      padding-bottom: 0;
    }
    
    /* Desktop layout */
    @media (min-width: 1024px) {
      .mobile-header {
        display: none;
      }
      
      .sidebar {
        position: relative;
        transform: translateX(0);
        height: 100vh;
      }
      
      .close-sidebar {
        display: none;
      }
      
      .app-container {
        display: flex;
        height: 100vh;
      }
      
      .main-content {
        flex: 1;
        overflow-y: auto;
        padding: 2rem;
      }
      
      .sidebar-overlay {
        display: none !important;
      }
      /* ADD THESE STYLES sa CSS section */
.sold-cards-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(380px, 1fr));
  gap: 1.5rem;
  margin-top: 1.5rem;
}

.sold-card {
  background: white;
  border-radius: 12px;
  padding: 1.5rem;
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
  border: 1px solid var(--pastel-pink);
  transition: var(--transition);
  position: relative;
}

.sold-card:hover {
  transform: translateY(-3px);
  box-shadow: 0 12px 24px rgba(0, 0, 0, 0.12);
}

.sold-card-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: 1.25rem;
  padding-bottom: 1rem;
  border-bottom: 1px solid var(--pastel-gray);
}

.sold-card-title {
  font-size: 1.2rem;
  font-weight: 700;
  color: var(--text-dark);
  margin: 0 0 0.25rem 0;
}

.sold-card-subtitle {
  font-size: 0.85rem;
  color: var(--text-medium);
  margin: 0;
  font-weight: 500;
}

.sold-card-details {
  font-size: 0.9rem;
  color: var(--text-medium);
  margin-bottom: 1.5rem;
}

.sold-card-details div {
  margin-bottom: 0.75rem;
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 0.5rem 0;
  border-bottom: 1px dashed var(--pastel-gray);
}

.sold-card-details div:last-child {
  border-bottom: none;
}

.sold-card-details strong {
  color: var(--text-dark);
  min-width: 100px;
  font-weight: 600;
}

.sold-card-details span {
  text-align: right;
  flex: 1;
  word-break: break-word;
}

.sold-card-actions {
  display: flex;
  gap: 0.75rem;
  margin-top: 1.25rem;
  padding-top: 1rem;
  border-top: 1px solid var(--pastel-gray);
}

.sold-card-actions .btn {
  flex: 1;
  margin: 0;
  padding: 0.6rem 0.5rem;
  font-size: 0.85rem;
}
/* --- Fix Netflix Collapsible Sections --- */

/* --- Netflix collapsed: show only email line --- */
.netflix-account-card.collapsed .netflix-account-actions{display:none !important;}
.netflix-account-card.collapsed .netflix-notes-section{display:none !important;}
.netflix-account-card.collapsed .netflix-profiles-section{display:none !important;}
.netflix-account-card.collapsed .netflix-account-info{display:none !important;}
.netflix-account-toggle-icon{transition: transform .2s ease;}
.netflix-account-card:not(.collapsed) .netflix-account-toggle-icon{transform: rotate(180deg);}

.netflix-account-card.collapsed .netflix-profiles-section {
    display: none !important;
}

.netflix-account-card.collapsed .netflix-notes-section {
    display: none !important;
}

.netflix-account-card.collapsed .netflix-account-info {
    display: none !important;
}

.netflix-account-header {
    cursor: pointer;
}


    }
  

    /* === Mobile / overflow fixes === */
    .sold-card-details span,
    .record-card-details span,
    .detail-section span,
    td, th {
      overflow-wrap: anywhere;
      word-break: break-word;
    }

    .actions-cell > div {
      display: flex !important;
      flex-wrap: wrap;
      gap: 0.35rem !important;
      justify-content: flex-start;
    }

    .actions-cell button {
      min-width: 2.2rem;
    }

    /* Make overlay/modal usable on small screens */
    #detail-overlay .detail-card {
      max-height: 85vh;
      overflow-y: auto;
      width: min(520px, 92vw);
      margin: 0 auto;
    }

    #detail-overlay .detail-card::-webkit-scrollbar {
      width: 8px;
    }

    /* Prevent big buttons from going off-screen */
    .btn, button.btn {
      max-width: 100%;
    }

    /* Tables: allow horizontal scroll if needed */
    .table-container, .records-table-wrapper {
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }

    @media (max-width: 420px) {
      body { font-size: 14px; }
      .card, .sold-card, .record-card { padding: 0.9rem !important; }
      .btn { padding: 0.55rem 0.8rem !important; }
      .badge { font-size: 0.72rem !important; }
      h1, h2, h3 { word-break: break-word; }
    }
</style>
</head>
<body>
  <!-- PIN GATE -->
  <!-- DETAIL OVERLAY -->
  <div class="detail-overlay" id="detail-overlay">
    <div class="detail-card">
      <button class="detail-close" onclick="closeDetailOverlay()">
        <i class="fas fa-times"></i>
      </button>
      <div id="detail-content"></div>
    </div>
  </div>

  <!-- MOBILE HEADER -->
  <div class="mobile-header">
    <button class="menu-toggle" onclick="toggleSidebar()">
      <i class="fas fa-bars"></i>
    </button>
    <div class="brand-mobile">
      <div class="brand-icon">
        <i class="fas fa-boxes"></i>
      </div>
      <div class="brand-text">
        <h1>AiaxStock</h1>
        <p>Owner Panel</p>
      </div>
    </div>
    <div></div>
  </div>

  <!-- SIDEBAR OVERLAY -->
  <div class="sidebar-overlay" onclick="toggleSidebar()"></div>

  <!-- SIDEBAR -->
  <div class="sidebar">
    <div class="sidebar-header">
      <div class="brand-mobile">
        <div class="brand-icon">
          <i class="fas fa-boxes"></i>
        </div>
        <div class="brand-text">
          <h1>AiaxStock</h1>
          <p>Owner Control Panel</p>
        </div>
      </div>
      <button class="close-sidebar" onclick="toggleSidebar()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    
    <div class="nav-section">
      <button class="nav-btn active" data-panel="dashboard">
        <i class="fas fa-tachometer-alt"></i>
        Dashboard
      </button>
    </div>
    
    <div class="nav-section">
      <h3>Stock Management</h3>
      <button class="nav-btn" data-panel="add-stock">
        <i class="fas fa-plus-circle"></i>
        Add Stock
      </button>
      <button class="nav-btn" data-panel="manage-stock">
        <i class="fas fa-edit"></i>
        Manage Stocks
      </button>
      <button class="nav-btn" data-panel="sold-stock">
        <i class="fas fa-check-circle"></i>
        Sold Accounts
      </button>
    
      <button class="nav-btn" data-panel="premium-stock">
        <i class="fas fa-star"></i>
        Premium Stock
      </button>
</div>
    <!-- Sa <body> section, hanapin ang .nav-section para sa Sales Records -->
<div class="nav-section">
  <h3>Sales Records</h3>
  <button class="nav-btn" data-panel="all-records">
    <i class="fas fa-list"></i>
    All Records
  </button>
  <button class="nav-btn" data-panel="auto-records">
    <i class="fas fa-robot"></i>
    TG Bot Sales
  </button>
  <button class="nav-btn" data-panel="manual-records">
    <i class="fas fa-user-edit"></i>
    Manual Sales
  </button>
  <button class="nav-btn" data-panel="add-record">
    <i class="fas fa-plus-square"></i>
    Add Manual Sale
  </button>
  <!-- DAGDAG: Netflix Management Tab -->
  <button class="nav-btn" data-panel="netflix-management">
    <i class="fas fa-film"></i>
    Netflix Management
  </button>
</div>
    
    <div class="nav-section">
      <h3>Settings</h3>
      <button class="nav-btn" data-panel="rules">
        <i class="fas fa-ruler-combined"></i>
        Product Rules
      </button>
    </div>
    
    <div style="flex: 1;"></div>
    
    <div class="nav-section">
      <button class="btn btn-secondary btn-full" onclick="downloadRecordsCsv()">
        <i class="fas fa-download"></i>
        Export CSV
      </button>
    </div>
  </div>

  <!-- MAIN CONTENT -->
  <div class="main-content" id="main-content">
    
    <!-- DASHBOARD PANEL -->
    <div id="dashboard-panel" class="content-panel active">
      <div class="panel-header">
        <h3><i class="fas fa-tachometer-alt"></i> Dashboard Overview</h3>
        <div class="panel-actions">
          <button class="btn btn-primary" onclick="refreshDashboard()">
            <i class="fas fa-sync-alt"></i> Refresh
          </button>
        </div>
      </div>
      
      <!-- SALES SUMMARY CARDS - FIXED -->
      <div class="stats-cards">
        <div class="stat-card">
          <div class="stat-icon pink">
            <i class="fas fa-robot"></i>
          </div>
          <div class="stat-info">
            <h3 id="stats-auto">0</h3>
            <p>TG Bot Sales</p>
          </div>
        </div>
        
        <div class="stat-card">
          <div class="stat-icon blue">
            <i class="fas fa-user-edit"></i>
          </div>
          <div class="stat-info">
            <h3 id="stats-manual">0</h3>
            <p>Manual Sales</p>
          </div>
        </div>
        
        <div class="stat-card">
          <div class="stat-icon green">
            <i class="fas fa-box"></i>
          </div>
          <div class="stat-info">
            <h3 id="stats-available">0</h3>
            <p>Available Stocks</p>
          </div>
        </div>
        
        <div class="stat-card">
          <div class="stat-icon purple">
            <i class="fas fa-chart-bar"></i>
          </div>
          <div class="stat-info">
            <h3 id="stats-revenue">₱0</h3>
            <p>Total Revenue</p>
          </div>
        </div>
      </div>
      
      <div style="display: flex; flex-direction: column; gap: 1.5rem;">
        <div>
          <h4 style="margin-top: 0; color: var(--text-medium); margin-bottom: 1rem;">
            <i class="fas fa-history"></i> Recent Sales
          </h4>
          <div class="table-container">
            <table class="table" id="recent-sales">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Buyer</th>
                  <th>Product</th>
                  <th>Amount</th>
                  <th>Date</th>
                </tr>
              </thead>
              <tbody>
                <tr><td colspan="5" style="text-align: center; padding: 2rem;">Loading...</td></tr>
              </tbody>
            </table>
          </div>
        </div>
        
        <div>
          <h4 style="margin-top: 0; color: var(--text-medium); margin-bottom: 1rem;">
            <i class="fas fa-exclamation-triangle"></i> Low Stock Alert
          </h4>
          <div class="table-container">
            <table class="table" id="low-stock">
              <thead>
                <tr>
                  <th>Product</th>
                  <th>Remaining</th>
                </tr>
              </thead>
              <tbody>
                <tr><td colspan="2" style="text-align: center; padding: 2rem;">Loading...</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
    
    <!-- ADD STOCK PANEL -->
    <div id="add-stock-panel" class="content-panel">
      <div class="panel-header">
        <h3><i class="fas fa-plus-circle"></i> Add Stock</h3>
        <div class="panel-actions">
          <button class="btn btn-primary" onclick="populateAddStockDropdowns()">
            <i class="fas fa-redo"></i> Refresh
          </button>
        </div>
      </div>
      
      <form id="addStockForm" class="form-grid">
        <div class="form-group">
          <label>Product</label>
          <select id="stock-product" class="form-control" required></select>
        </div>
        
        <div class="form-group">
          <label>Plan Type</label>
          <select id="stock-type" class="form-control" required></select>
        </div>
        
        <div class="form-group">
          <label>Duration</label>
          <select id="stock-duration" class="form-control" required></select>
        </div>
        
        <div class="form-group">
          <label>Quantity</label>
          <input type="number" id="stock-qty" class="form-control" value="1" min="1" required />
        </div>
        
        <div class="form-group">
          <label>Auto-archive (days)</label>
          <input type="number" id="stock-arch" class="form-control" value="30" min="0" />
        </div>
        
        <div class="form-group">
          <label>Account Email</label>
          <input type="text" id="stock-email" class="form-control" required placeholder="account@example.com" />
        </div>
        
        <div class="form-group">
          <label>Account Password</label>
          <input type="text" id="stock-password" class="form-control" required placeholder="Password" />
        </div>
        
        <div class="form-group">
          <label>Profile (optional)</label>
          <input type="text" id="stock-profile" class="form-control" placeholder="Profile 1" />
        </div>
        
        <div class="form-group">
          <label>PIN (optional)</label>
          <input type="text" id="stock-pin" class="form-control" />
        </div>
        
        <div class="form-group">
          <label>Premium Until (optional)</label>
          <input type="date" id="stock-premdate" class="form-control" />
        </div>
        
        <div class="form-group">
          <button type="submit" class="btn btn-primary btn-full">
            <i class="fas fa-plus"></i> Add Stock
          </button>
        </div>
      </form>
      <div id="msg-add"></div>
    </div>
    
    <!-- MANAGE STOCKS PANEL -->
    <div id="manage-stock-panel" class="content-panel">
      <div class="panel-header">
        <h3><i class="fas fa-edit"></i> Manage Stocks</h3>
        <div class="panel-actions">
          <button class="btn btn-primary" onclick="loadManageStocks()">
            <i class="fas fa-redo"></i> Refresh
          </button>
        </div>
      </div>
      
      <div class="filters-row">
        <div class="filter-group">
          <label>Filter by Product</label>
          <select id="manage-product-filter" class="form-control">
            <option value="all">All Products</option>
          </select>
        </div>
      </div>
      
      <div id="manage-list">
        <div style="text-align: center; padding: 2rem;">
          <i class="fas fa-spinner fa-spin"></i> Loading available stocks...
        </div>
      </div>
      
      <!-- Edit Stock Form -->
      <div id="edit-stock-form" style="display: none; margin-top: 2rem; padding: 1.5rem; background: rgba(255, 255, 255, 0.9); border-radius: 12px; border: 1px solid var(--pastel-pink);">
        <h4 style="margin-top: 0; color: var(--text-dark);">
          <i class="fas fa-edit"></i> Edit Stock Group
        </h4>
        <form id="editStockForm" class="form-grid">
          <input type="hidden" id="edit-ids" />
          
          <div class="form-group">
            <label>Email</label>
            <input type="text" id="edit-email" class="form-control" required />
          </div>
          
          <div class="form-group">
            <label>Password</label>
            <input type="text" id="edit-password" class="form-control" required />
          </div>
          
          <div class="form-group">
            <label>Profile</label>
            <input type="text" id="edit-profile" class="form-control" />
          </div>
          
          <div class="form-group">
            <label>PIN</label>
            <input type="text" id="edit-pin" class="form-control" />
          </div>
          
          <div class="form-group">
            <label>Auto-archive (days)</label>
            <input type="number" id="edit-arch" class="form-control" min="0" />
          </div>
          
          <div class="form-group">
            <label>Premium Until</label>
            <input type="date" id="edit-premdate" class="form-control" />
          </div>
          
          <div class="form-group">
            <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
              <button type="submit" class="btn btn-primary">
                <i class="fas fa-save"></i> Save Changes
              </button>
              <button type="button" class="btn btn-secondary" onclick="cancelEditStock()">
                <i class="fas fa-times"></i> Cancel
              </button>
            </div>
          </div>
        </form>
        <div id="msg-edit-stock"></div>
      </div>
    </div>
    
    <!-- SOLD STOCKS PANEL (UPDATED WITH SUMMARY CARDS) -->
    <div id="sold-stock-panel" class="content-panel">
      <div class="panel-header">
        <h3><i class="fas fa-check-circle"></i> Sold Accounts</h3>
        <div class="panel-actions">
          <button class="btn btn-primary" onclick="loadSoldStocks()">
            <i class="fas fa-redo"></i> Refresh
          </button>
        </div>
      </div>
      
      <!-- SUMMARY CARDS FOR SOLD ACCOUNTS -->
      <div class="stats-cards" id="sold-summary-cards" style="margin-bottom: 1.5rem;">
        <div class="stat-card">
          <div class="stat-icon pink">
            <i class="fas fa-robot"></i>
          </div>
          <div class="stat-info">
            <h3 id="sold-auto-count">0</h3>
            <p>TG Bot Sales</p>
          </div>
        </div>
        
        <div class="stat-card">
          <div class="stat-icon blue">
            <i class="fas fa-user-edit"></i>
          </div>
          <div class="stat-info">
            <h3 id="sold-manual-count">0</h3>
            <p>Manual Sales</p>
          </div>
        </div>
        
        <div class="stat-card">
          <div class="stat-icon green">
            <i class="fas fa-box"></i>
          </div>
          <div class="stat-info">
            <h3 id="sold-total-count">0</h3>
            <p>Total Sold</p>
          </div>
        </div>
        
        <div class="stat-card">
          <div class="stat-icon purple">
            <i class="fas fa-money-bill-wave"></i>
          </div>
          <div class="stat-info">
            <h3 id="sold-total-revenue">₱0</h3>
            <p>Total Revenue</p>
          </div>
        </div>
      </div>
      
      <!-- Auto Expiry Editor for Sold Accounts -->
      <div id="auto-expiry-editor" style="display: none; margin-bottom: 1.5rem; padding: 1.5rem; background: rgba(214, 255, 231, 0.3); border-radius: 12px; border: 1px solid var(--pastel-mint);">
        <h4 style="margin-top: 0; color: var(--text-dark);">
          <i class="fas fa-calendar-alt"></i> Edit Expiry for Stock <span id="auto-expiry-stock-label" class="badge badge-auto"></span>
        </h4>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
          <div>
            <label>Current Expiry</label>
            <input type="date" id="auto-current-expiry" class="form-control" readonly />
          </div>
          <div>
            <label>Add Days</label>
            <input type="number" id="auto-add-days" class="form-control" value="0" min="0" />
          </div>
          <div>
            <label>New Expiry Date</label>
            <input type="date" id="auto-expiry-date" class="form-control" />
          </div>
          <div style="grid-column: span 2; display: flex; gap: 0.5rem; align-items: flex-end;">
            <button type="button" class="btn btn-success" onclick="calculateAutoExpiry()">
              <i class="fas fa-calculator"></i> Calculate
            </button>
            <button type="button" class="btn btn-primary" onclick="saveAutoExpiry()">
              <i class="fas fa-save"></i> Save
            </button>
            <button type="button" class="btn btn-secondary" onclick="cancelAutoExpiry()">
              <i class="fas fa-times"></i> Cancel
            </button>
          </div>
        </div>
        <div id="auto-expiry-msg" style="margin-top: 0.5rem;"></div>
      </div>
      
      <div id="sold-list">
        <div style="text-align: center; padding: 2rem;">
          <i class="fas fa-spinner fa-spin"></i> Loading sold accounts...
        </div>
      </div>
    </div>
    
    <!-- ALL RECORDS PANEL -->
    
    <!-- PREMIUM STOCK PANEL -->
    <div id="premium-stock-panel" class="content-panel">
      <div class="panel-header">
        <h3><i class="fas fa-star"></i> Premium Stock (Basic Accounts)</h3>
        <div class="panel-actions">
          <button class="btn btn-primary" onclick="refreshPremiumStock()">
            <i class="fas fa-sync-alt"></i> Refresh
          </button>
        </div>
      </div>

      <div class="card">
        <h4 style="margin-bottom: .75rem;">Add Basic Account</h4>
        <div class="form-grid">
          <div class="form-group">
            <label>Product</label>
            <select id="premium-product" class="form-control"></select>
          </div>
          <div class="form-group">
            <label>Email / Login</label>
            <input id="premium-email" class="form-control" placeholder="email / username">
          </div>
          <div class="form-group">
            <label>Password</label>
            <input id="premium-pass" class="form-control" placeholder="password">
          </div>
        </div>
        <div style="display:flex; gap:.5rem; flex-wrap:wrap; margin-top:.5rem;">
          <button class="btn btn-primary" onclick="addPremiumStock()">
            <i class="fas fa-plus-circle"></i> Add to Premium Stock
          </button>
          <div id="premium-stock-msg" style="margin-left:auto; font-size:.9rem; opacity:.8;"></div>
        </div>
      </div>

      <div class="card" style="margin-top: 1rem;">
        <h4 style="margin-bottom: .75rem;">Premium Stock List</h4>

        
        <div class="form-grid" style="grid-template-columns: 1fr 1fr; gap: .75rem; margin-bottom: .75rem;">
          <div class="form-group">
            <label>Search</label>
            <input id="premium-stock-search" class="form-control" placeholder="search email / password...">
          </div>
          <div class="form-group">
            <label>Filter Product</label>
            <select id="premium-stock-filter" class="form-control"></select>
          </div>
        </div>
<div style="overflow:auto;">
          <table class="table" id="premium-stock-table">
            <thead>
              <tr>
                <th>#</th>
                <th>Product</th>
                <th>Email</th>
                <th>Password</th>
                <th style="min-width: 150px;">Actions</th>
              </tr>
            </thead>
            <tbody id="premium-stock-tbody">
              <tr><td colspan="5" style="text-align:center; padding:2rem;">Loading...</td></tr>
            </tbody>
          </table>
        </div>

        <p style="margin-top:.75rem; font-size:.9rem; opacity:.75;">
          Tip: Click <b>Premium</b> kapag napremium na ang account para mawala sa list.
        </p>
      </div>
    </div>

<div id="all-records-panel" class="content-panel">
      <div class="panel-header">
        <h3><i class="fas fa-list"></i> All Sales Records</h3>
        <div class="panel-actions">
          <button class="btn btn-primary" onclick="loadRecordsAll()">
            <i class="fas fa-sync-alt"></i> Refresh
          </button>
          <button class="btn btn-secondary" onclick="downloadRecordsCsv()">
            <i class="fas fa-download"></i> Export
          </button>
        </div>
      </div>
      
      <!-- Filters -->
      <div class="filters-row">
        <div class="filter-group">
          <label>Period</label>
          <select id="records-period" class="form-control">
            <option value="all">All Time</option>
            <option value="today" selected>Today</option>
            <option value="yesterday">Yesterday</option>
            <option value="week">This Week</option>
            <option value="month">This Month</option>
            <option value="custom">Custom Date</option>
          </select>
        </div>
        
        <div class="filter-group">
          <label>Platform</label>
          <select id="records-platform" class="form-control">
            <option value="all">All Platforms</option>
            <option value="TG">Telegram</option>
            <option value="IG">Instagram</option>
            <option value="FB">Facebook</option>
            <option value="TIKTOK">TikTok</option>
            <option value="OTHER">Other</option>
          </select>
        </div>
        
        <!-- PRODUCT FILTER - FIXED -->
        <div class="filter-group">
          <label>Product</label>
          <select id="records-product" class="form-control">
            <option value="all">All Products</option>
          </select>
        </div>
        
        <div class="filter-group" id="custom-date-group" style="display: none;">
          <label>Specific Date</label>
          <input type="date" id="records-specific-date" class="form-control" />
        </div>
      </div>
      
      <div id="records-summary" style="margin-bottom: 1rem; padding: 1rem; background: rgba(255, 255, 255, 0.7); border-radius: 12px; font-size: 0.9rem; color: var(--text-medium);">Loading...</div>
        <div class="table-container">
        <table class="table" id="records-table">
          <thead>
            <tr>
              <th>#</th>
              <th>Source</th>
              <th>Buyer</th>
              <th>Product</th>
              <th>Login</th>
              <th>Price</th><th>Stock Age</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <tr><td colspan="7" style="text-align: center; padding: 2rem;">Loading records...</td></tr>
          </tbody>
        </table>
      </div>
    </div>
    
    <!-- AUTO RECORDS PANEL -->
    <div id="auto-records-panel" class="content-panel">
      <div class="panel-header">
        <h3><i class="fas fa-robot"></i> TG Bot Sales</h3>
        <div class="panel-actions">
          <button class="btn btn-primary" onclick="loadRecordsAuto()">
            <i class="fas fa-sync-alt"></i> Refresh
          </button>
        </div>
      </div>
      
      <div class="filters-row">
        <div class="filter-group">
          <label>Period</label>
          <select id="auto-records-period" class="form-control">
            <option value="all">All Time</option>
            <option value="today" selected>Today</option>
            <option value="yesterday">Yesterday</option>
            <option value="week">This Week</option>
            <option value="month">This Month</option>
          </select>
        </div>
        
        <!-- PRODUCT FILTER - FIXED -->
        <div class="filter-group">
          <label>Product</label>
          <select id="auto-records-product" class="form-control">
            <option value="all">All Products</option>
          </select>
        </div>
      </div>
      
      <div id="records-auto-summary" style="margin-bottom: 1rem; padding: 1rem; background: rgba(255, 255, 255, 0.7); border-radius: 12px; font-size: 0.9rem; color: var(--text-medium);">Loading...</div>
      
      <div class="table-container">
        <table class="table" id="auto-records-table">
          <thead>
            <tr>
              <th>#</th>
              <th>Buyer</th>
              <th>Product</th>
              <th>Login</th>
              <th>Price</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <tr><td colspan="6" style="text-align: center; padding: 2rem;">Loading TG bot sales...</td></tr>
          </tbody>
        </table>
      </div>
    </div>
    
    <!-- MANUAL RECORDS PANEL -->
    <div id="manual-records-panel" class="content-panel">
      <div class="panel-header">
        <h3><i class="fas fa-user-edit"></i> Manual Sales</h3>
        <div class="panel-actions">
          <button class="btn btn-primary" onclick="loadRecordsManual()">
            <i class="fas fa-sync-alt"></i> Refresh
          </button>
        </div>
      </div>
      
      <div class="filters-row">
        <div class="filter-group">
          <label>Period</label>
          <select id="manual-records-period" class="form-control">
            <option value="all">All Time</option>
            <option value="today" selected>Today</option>
            <option value="yesterday">Yesterday</option>
            <option value="week">This Week</option>
            <option value="month">This Month</option>
          </select>
        </div>
        
        <!-- PRODUCT FILTER - FIXED -->
        <div class="filter-group">
          <label>Product</label>
          <select id="manual-records-product" class="form-control">
            <option value="all">All Products</option>
          </select>
        </div>
      </div>
      
      <div id="records-manual-summary" style="margin-bottom: 1rem; padding: 1rem; background: rgba(255, 255, 255, 0.7); border-radius: 12px; font-size: 0.9rem; color: var(--text-medium);">Loading...</div>
      
      <div class="table-container">
        <table class="table" id="manual-records-table">
          <thead>
            <tr>
              <th>#</th>
              <th>Buyer</th>
              <th>Product</th>
              <th>Login</th>
              <th>Price</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <tr><td colspan="6" style="text-align: center; padding: 2rem;">Loading manual sales...</td></tr>
          </tbody>
        </table>
      </div>
    </div>
    
    <!-- ADD MANUAL RECORD PANEL -->
    <div id="add-record-panel" class="content-panel">
      <div class="panel-header">
        <h3><i class="fas fa-plus-square"></i> Add Manual Sale</h3>
        <div class="panel-actions">
          <button class="btn btn-primary" onclick="populateManualDropdowns()">
            <i class="fas fa-redo"></i> Refresh
          </button>
        </div>
      </div>
      
      <form id="manualRecordForm" class="form-grid">
        <input type="hidden" id="manual-id" />
        
        <div class="form-group">
          <label>Buyer Name</label>
          <input type="text" id="manual-buyer-name" class="form-control" />
        </div>
        
        <div class="form-group">
          <label>Buyer Telegram ID (optional)</label>
          <input type="text" id="manual-buyer-tg" class="form-control" />
        </div>
        
        <div class="form-group">
          <label>Platform</label>
          <select id="manual-platform" class="form-control">
            <option value="TG">Telegram</option>
            <option value="IG">Instagram</option>
            <option value="FB">Facebook</option>
            <option value="TIKTOK">TikTok</option>
            <option value="OTHER">Other</option>
          </select>
        </div>
        
        <div class="form-group">
          <label>Product</label>
          <select id="manual-product" class="form-control" required></select>
        </div>
        
        <div class="form-group">
          <label>Plan Type</label>
          <select id="manual-plan-type" class="form-control" required></select>
        </div>
        
        <div class="form-group">
          <label>Duration</label>
          <select id="manual-duration" class="form-control" required></select>
        </div>
        
        <div class="form-group">
          <label>Price</label>
          <input type="number" id="manual-price" class="form-control" min="0" step="0.01" required />
        </div>
        
        <div class="form-group">
          <label>Account Email</label>
          <input type="text" id="manual-email" class="form-control" required />
        </div>
        
        <div class="form-group">
          <label>Account Password</label>
          <input type="text" id="manual-password" class="form-control" />
        </div>
        
        <div class="form-group">
          <label>Profile (optional)</label>
          <input type="text" id="manual-profile" class="form-control" />
        </div>
        
        <div class="form-group">
          <label>PIN (optional)</label>
          <input type="text" id="manual-pin" class="form-control" />
        </div>
        
        <div class="form-group">
          <label>Date Availed</label>
          <input type="date" id="manual-date-availed" class="form-control" required />
        </div>
        
        <!-- AUTO-COMPUTE EXPIRY FIELDS FROM ORIGINAL CODE -->
        <div class="form-group">
          <label>Additional Days</label>
          <input type="number" id="manual-add-days" class="form-control" value="0" />
        </div>
        
        <div class="form-group">
          <label>Old Expiry (auto)</label>
          <input type="date" id="manual-old-expiry" class="form-control" readonly />
        </div>
        
        <div class="form-group">
          <label>New Expiry (auto)</label>
          <input type="date" id="manual-new-expiry" class="form-control" readonly />
        </div>
        
        <div class="form-group">
          <label>Notes (optional)</label>
          <textarea id="manual-notes" class="form-control" rows="3" placeholder="Remarks, payment reference, etc."></textarea>
        </div>
        
        <div class="form-group">
          <button type="submit" class="btn btn-primary btn-full">
            <i class="fas fa-save"></i> Save Manual Record
          </button>
        </div>
      </form>
      <div id="msg-record"></div>
    </div>
    <!-- Idagdag ito sa main-content section, kasama ng ibang panels -->
<!-- NETFLIX MANAGEMENT PANEL -->
<div id="netflix-management-panel" class="content-panel">
  <div class="panel-header">
    <h3><i class="fas fa-film"></i> Netflix Account Management</h3>
    <div class="panel-actions">
      <button class="btn btn-primary" onclick="loadNetflixAccounts()">
        <i class="fas fa-sync-alt"></i> Refresh
      </button>
      <button class="btn btn-success" onclick="showAddNetflixAccount()">
        <i class="fas fa-plus"></i> Add Netflix Account
      </button>
    </div>
  </div>

  <!-- Netflix Account Summary Cards -->
  <div class="stats-cards" id="netflix-summary-cards" style="margin-bottom: 1.5rem;">
    <div class="stat-card">
      <div class="stat-icon pink">
        <i class="fas fa-envelope"></i>
      </div>
      <div class="stat-info">
        <h3 id="netflix-account-count">0</h3>
        <p>Total Accounts</p>
      </div>
    </div>
    
    <div class="stat-card">
      <div class="stat-icon blue">
        <i class="fas fa-users"></i>
      </div>
      <div class="stat-info">
        <h3 id="netflix-user-count">0</h3>
        <p>Active Users</p>
      </div>
    </div>
    
    <div class="stat-card">
      <div class="stat-icon green">
        <i class="fas fa-user-check"></i>
      </div>
      <div class="stat-info">
        <h3 id="netflix-slot-count">0/0</h3>
        <p>Used Slots</p>
      </div>
    </div>
    
    <div class="stat-card">
      <div class="stat-icon purple">
        <i class="fas fa-calendar-alt"></i>
      </div>
      <div class="stat-info">
        <h3 id="netflix-expiry-count">0</h3>
        <p>Expiring Soon</p>
      </div>
    </div>
  </div>

  <!-- Netflix Account Search/Filter -->
  <div class="filters-row">
    <div class="filter-group">
      <label>Search Account</label>
      <input type="text" id="netflix-search" class="form-control" 
        placeholder="Search by email or profile..." 
        onkeyup="filterNetflixAccounts()" />
    </div>
    
    <div class="filter-group">
      <label>Status</label>
      <select id="netflix-status-filter" class="form-control" onchange="filterNetflixAccounts()">
        <option value="all">All Status</option>
        <option value="active">Active</option>
        <option value="inactive">Inactive</option>
        <option value="full">Full</option>
        <option value="available">Has Available Slots</option>
      </select>
    </div>
  </div>

  <!-- Netflix Accounts List -->
  <div id="netflix-accounts-list" style="margin-top: 1.5rem;">
    <div style="text-align: center; padding: 2rem;">
      <i class="fas fa-spinner fa-spin"></i> Loading Netflix accounts...
    </div>
  </div>

  <!-- Add/Edit Netflix Account Modal (hidden by default) -->
  <div id="netflix-account-modal" style="display: none; margin-top: 2rem; padding: 1.5rem; 
        background: white; border-radius: var(--border-radius); border: 1px solid var(--pastel-pink);">
    <h4 style="margin-top: 0; color: var(--text-dark); display: flex; justify-content: space-between;">
      <span><i class="fas fa-film"></i> <span id="netflix-modal-title">Add Netflix Account</span></span>
      <button class="btn btn-sm btn-secondary" onclick="closeNetflixModal()">
        <i class="fas fa-times"></i>
      </button>
    </h4>
    
    <form id="netflixAccountForm" class="form-grid">
      <input type="hidden" id="netflix-account-id" />
      
      <div class="form-group">
        <label>Email Address *</label>
        <input type="email" id="netflix-email" class="form-control" required 
          placeholder="netflix@example.com" />
      </div>
      
      <div class="form-group">
        <label>Password *</label>
        <input type="text" id="netflix-password" class="form-control" required 
          placeholder="Account password" />
      </div>
      
      <div class="form-group">
        <label>Notes (Optional)</label>
        <textarea id="netflix-notes" class="form-control" rows="2" 
          placeholder="Any notes about this account..."></textarea>
      </div>
      
      <div class="form-group">
        <label>Status</label>
        <select id="netflix-is-active" class="form-control">
          <option value="true">Active</option>
          <option value="false">Inactive</option>
        </select>
      </div>
      
      <!-- Auto-create 5 profiles -->
      <div class="form-group" style="grid-column: 1 / -1;">
        <label style="margin-bottom: 0.5rem; display: block;">
          <input type="checkbox" id="auto-create-profiles" checked /> 
          Auto-create 5 profiles (Profile 1-5)
        </label>
        <small style="color: var(--text-light);">
          Uncheck if you want to manually create profiles later
        </small>
      </div>
      
      <div class="form-group" style="grid-column: 1 / -1;">
        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
          <button type="submit" class="btn btn-primary">
            <i class="fas fa-save"></i> Save Account
          </button>
          <button type="button" class="btn btn-secondary" onclick="closeNetflixModal()">
            <i class="fas fa-times"></i> Cancel
          </button>
        </div>
      </div>
    </form>
    <div id="netflix-account-msg" style="margin-top: 1rem;"></div>
  </div>

  <!-- Add User to Profile Modal -->
  <div id="netflix-add-user-modal" style="display: none; margin-top: 2rem; padding: 1.5rem; 
        background: white; border-radius: var(--border-radius); border: 1px solid var(--pastel-blue);">
    <h4 style="margin-top: 0; color: var(--text-dark); display: flex; justify-content: space-between;">
      <span><i class="fas fa-user-plus"></i> Add User to Profile</span>
      <button class="btn btn-sm btn-secondary" onclick="closeAddUserModal()">
        <i class="fas fa-times"></i>
      </button>
    </h4>
    
    <form id="netflixAddUserForm" class="form-grid">
      <input type="hidden" id="adduser-profile-id" />
      <input type="hidden" id="adduser-account-id" />
      
      <div class="form-group">
        <label>Profile</label>
        <input type="text" id="adduser-profile-info" class="form-control" readonly />
      </div>
      
      <div class="form-group">
        <label>Buyer Name *</label>
        <input type="text" id="adduser-buyer-name" class="form-control" required 
          placeholder="Buyer's name" />
      </div>
      
      <div class="form-group">
        <label>Buyer Telegram ID (Optional)</label>
        <input type="text" id="adduser-buyer-tg" class="form-control" 
          placeholder="@username or 123456789" />
      </div>
      
     <div class="form-group">
  <label>Link to Existing Sale Record (Optional)</label>
  <div style="display:flex; gap:.5rem; width:100%;">
    <select id="adduser-sale-record" class="form-control" style="flex:1;">
      <option value="">-- Select sale record --</option>
    </select>

    <!-- 👇 NEW BUTTON -->
    <button type="button" class="btn btn-secondary" style="padding:0 .75rem;"
            onclick="openInlineManualSaleForm()">
      <i class="fas fa-plus"></i>
    </button>
  </div>
  <small style="color: var(--text-light);">
    Create new manual sale record for this user
  </small>
</div>

<!-- 👇 INLINE FORM (Hidden by default) -->
<div id="inline-manual-sale-form" 
     style="display:none; padding:1rem; border-radius:12px; 
            background:#fff0f6; border:1px solid #ffb3d9; margin-top:1rem;">

  <h4 style="margin:0 0 .75rem 0;">Create Manual Sale</h4>

  <div class="form-group">
    <label>Product</label>
    <select id="inline-product" class="form-control"></select>
  </div>

  <div class="form-group">
    <label>Plan Type</label>
    <select id="inline-plantype" class="form-control"></select>
  </div>

  <div class="form-group">
    <label>Duration</label>
    <select id="inline-duration" class="form-control"></select>
  </div>

  <div class="form-group">
    <label>Price</label>
    <input type="number" id="inline-price" class="form-control">
  </div>

  <div class="form-group">
    <label>Account Email</label>
    <input type="text" id="inline-email" class="form-control">
  </div>

  <div class="form-group">
    <label>Password (optional)</label>
    <input type="text" id="inline-pass" class="form-control">
  </div>

  <button class="btn btn-primary" onclick="saveInlineManualRecord()">
    <i class="fas fa-save"></i> Save Manual Sale
  </button>
</div>

      
      <div class="form-group">
        <label>Date Availed *</label>
        <input type="date" id="adduser-date-availed" class="form-control" required 
          value="<?php echo date('Y-m-d'); ?>" />
      </div>
      
      <div class="form-group">
        <label>Expiry Date *</label>
        <input type="date" id="adduser-expiry-date" class="form-control" required />
      </div>
      
      <div class="form-group" style="grid-column: 1 / -1;">
        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
          <button type="submit" class="btn btn-primary">
            <i class="fas fa-user-plus"></i> Add User
          </button>
          <button type="button" class="btn btn-secondary" onclick="closeAddUserModal()">
            <i class="fas fa-times"></i> Cancel
          </button>
        </div>
      </div>
    </form>
    <div id="netflix-adduser-msg" style="margin-top: 1rem;"></div>
  </div>
</div>
    <!-- RULES PANEL -->
    <div id="rules-panel" class="content-panel">
      <div class="panel-header">
        <h3><i class="fas fa-ruler-combined"></i> Product Rules</h3>
        <div class="panel-actions">
          <button class="btn btn-primary" onclick="loadRulesList()">
            <i class="fas fa-sync-alt"></i> Refresh
          </button>
        </div>
      </div>
      
      <div style="display: flex; flex-direction: column; gap: 2rem;">
        <div>
          <h4 style="margin-top: 0; color: var(--text-dark);">
            <i class="fas fa-plus-circle"></i> Add/Edit Rule
          </h4>
          <form id="rulesForm">
            <input type="hidden" id="rules-id" />
            
            <div class="form-group">
              <label>Product</label>
              <select id="rules-product" class="form-control" required></select>
            </div>
            
            <div class="form-group">
              <label>Rule Text</label>
              <textarea id="rules-text" class="form-control" rows="4" 
                placeholder="Do not change password, do not log out on other devices, etc." required></textarea>
            </div>
            
            <button type="submit" class="btn btn-primary">
              <i class="fas fa-save"></i> Save Rule
            </button>
          </form>
          <div id="msg-rules" style="margin-top: 1rem;"></div>
        </div>
        
        <div>
          <h4 style="margin-top: 0; color: var(--text-dark);">
            <i class="fas fa-list"></i> Existing Rules
          </h4>
          <div id="rules-list">
            Select a product to view rules...
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
  // Supabase Configuration
  const SB_URL = 'https://mjjxvusreufrkwheuafp.supabase.co';
  const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1qanh2dXNyZXVmcmt3aGV1YWZwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ3ODMxMTIsImV4cCI6MjA4MDM1OTExMn0.mzbhpxJmI8_gcpsoX4AEKoSt6u1iMRJqvDPaRsiky4I';

  const supabaseClient = window.supabase.createClient(SB_URL, SB_KEY);

  // Helpers (safe fallbacks for inconsistent DB fields)
  function pickFirst(...vals) {
    for (const v of vals) {
      if (v === 0) return v;
      if (v === false) return v;
      if (v !== undefined && v !== null && String(v).trim() !== '') return v;
    }
    return null;
  }

  function formatDateAny(v) {
    if (!v) return null;
    try {
      const d = new Date(v);
      if (isNaN(d.getTime())) return null;
      return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
    } catch (e) {
      return null;
    }
  }

  function normalizeTelegram(val) {
    if (!val) return null;
    const s = String(val).trim();
    if (!s) return null;
    if (s === 'N/A' || s === '-') return null;
    return s;
  }
let ownerProducts = [];
  let ownerPlans = [];
  let lastRecords = [];
  let currentAutoExpiryStockId = null;

  // ---------- Mobile sidebar functions ----------
  function toggleSidebar() {
    const sidebar = document.querySelector('.sidebar');
    const overlay = document.querySelector('.sidebar-overlay');
    
    sidebar.classList.toggle('active');
    overlay.classList.toggle('active');
    
    if (sidebar.classList.contains('active')) {
      document.body.style.overflow = 'hidden';
    } else {
      document.body.style.overflow = 'auto';
    }
  }

  function closeSidebar() {
    const sidebar = document.querySelector('.sidebar');
    const overlay = document.querySelector('.sidebar-overlay');
    
    sidebar.classList.remove('active');
    overlay.classList.remove('active');
    document.body.style.overflow = 'auto';
  }

  // ---------- Detail Overlay Functions ----------
  function showDetailOverlay(content) {
    const overlay = document.getElementById('detail-overlay');
    const contentDiv = document.getElementById('detail-content');
    
    if (overlay && contentDiv) {
      contentDiv.innerHTML = content;
      overlay.classList.add('active');
      document.body.style.overflow = 'hidden';
    }
  }

  function closeDetailOverlay() {
    const overlay = document.getElementById('detail-overlay');
    if (overlay) {
      overlay.classList.remove('active');
      document.body.style.overflow = 'auto';
    }
  }

  // ---------- PIN Authentication ----------
  document.addEventListener('DOMContentLoaded', function() {
    // Setup PIN authentication
    const pinBtn = document.getElementById('btn-pin');
    // No-PIN mode: always initialize the owner panel
document.addEventListener('DOMContentLoaded', () => {
  try {
    const gate = document.getElementById('pin-gate');
    if (gate) gate.remove();
    // Ensure app containers (if any) are visible
    const app = document.getElementById('app');
    if (app) app.style.display = '';
  } catch (e) { console.error(e); }
  try { initOwnerApp(); } catch (e) { console.error(e); }
});

// Setup navigation
    setupNavigation();
    
    // Close sidebar when clicking outside
    const overlay = document.querySelector('.sidebar-overlay');
    if (overlay) {
      overlay.addEventListener('click', closeSidebar);
    }
    
    // Close detail overlay when clicking outside
    const detailOverlay = document.getElementById('detail-overlay');
    if (detailOverlay) {
      detailOverlay.addEventListener('click', function(e) {
        if (e.target === this) {
          closeDetailOverlay();
        }
      });
    }
    
    // Responsive check
    checkScreenSize();
    window.addEventListener('resize', checkScreenSize);
  });

  function checkScreenSize() {
    const isDesktop = window.innerWidth >= 1024;
    const sidebar = document.querySelector('.sidebar');
    const mobileHeader = document.querySelector('.mobile-header');
    const mainContent = document.querySelector('.main-content');
    
    if (isDesktop) {
      if (sidebar) sidebar.classList.add('active');
      if (mobileHeader) mobileHeader.style.display = 'none';
      if (mainContent) mainContent.style.marginTop = '0';
    } else {
      if (sidebar) sidebar.classList.remove('active');
      if (mobileHeader) mobileHeader.style.display = 'flex';
      if (mainContent) mainContent.style.marginTop = '60px';
    }
  }

  function checkPin() {
    const pinInput = document.getElementById('owner-pin');
    const pinValue = pinInput.value.trim();
    const errBox = document.getElementById('pin-error');
    
    if (true) { // PIN gate disabled
      document.getElementById('pin-gate').style.display = 'none';
      localStorage.setItem('aiaxstock_authenticated', 'true');
      initOwnerApp();
    } else {
      if (errBox) {
        errBox.textContent = 'Incorrect PIN. Please try again.';
      }
      if (pinInput) {
        pinInput.value = '';
        pinInput.focus();
      }
    }
  }

  // ---------- Navigation Setup ----------
  function setupNavigation() {
    const navButtons = document.querySelectorAll('.nav-btn');
    
    navButtons.forEach(btn => {
      btn.addEventListener('click', function(e) {
        e.preventDefault();
        
        // Update active state
        navButtons.forEach(b => b.classList.remove('active'));
        this.classList.add('active');
        
        // Close sidebar on mobile
        if (window.innerWidth < 1024) {
          closeSidebar();
        }
        
        // Show corresponding panel
        const panelId = this.getAttribute('data-panel') + '-panel';
        document.querySelectorAll('.content-panel').forEach(p => {
          p.classList.remove('active');
        });
        
        const targetPanel = document.getElementById(panelId);
        if (targetPanel) {
          targetPanel.classList.add('active');
          
          // Load data for the panel
          loadPanelData(panelId);
          
          // Scroll to top
          setTimeout(() => {
            const mainContent = document.getElementById('main-content');
            if (mainContent) {
              mainContent.scrollTo(0, 0);
            }
          }, 100);
        }
      });
    });
  }

  function loadPanelData(panelId) {
    switch(panelId) {
      case 'dashboard-panel':
        loadDashboard();
        break;
      case 'add-stock-panel':
        populateAddStockDropdowns();
        break;
      case 'manage-stock-panel':
        loadManageStocks();
        break;
      case 'sold-stock-panel':
        loadSoldStocks();
        break;
      case 'premium-stock-panel':
        initPremiumStockPanel();
        break;
      case 'all-records-panel':
        loadRecordsAll();
        break;
      case 'auto-records-panel':
        loadRecordsAuto();
        break;
      case 'manual-records-panel':
        loadRecordsManual();
        break;
      case 'add-record-panel':
        populateManualDropdowns();
        initManualExpiryCalculator(); // Initialize expiry calculator
        break;
      case 'rules-panel':
        loadRulesList();
        break;
    }
  }


  // ---------- Premium Stock (Basic Accounts) ----------
  const PREMIUM_STOCK_TABLE = 'premium_stock_accounts';

  function escapeHtml(str) {
    return String(str ?? '')
      .replaceAll('&', '&amp;')
      .replaceAll('<', '&lt;')
      .replaceAll('>', '&gt;')
      .replaceAll('"', '&quot;')
      .replaceAll("'", '&#39;');
  }


  async function populatePremiumProducts() {
    const sel = document.getElementById('premium-product');
    if (!sel) return;

    sel.innerHTML = '<option value="">Loading...</option>';

    try {
      const { data: products, error } = await supabaseClient
        .from('products')
        .select('id,name,active')
        .order('name', { ascending: true });

      if (error) throw error;

      const activeProducts = (products || []).filter(p => p.active !== false);
      sel.innerHTML = '<option value="">Select product</option>' + activeProducts
        .map(p => `<option value="${p.id}">${escapeHtml(p.name)}</option>`)
        .join('');
    } catch (err) {
      sel.innerHTML = '<option value="">(Failed to load products)</option>';
      console.error('populatePremiumProducts error:', err);
    }
  }

  function setPremiumMsg(msg, isError=false) {
    const el = document.getElementById('premium-stock-msg');
    if (!el) return;
    el.textContent = msg || '';
    el.style.color = isError ? '#c0392b' : '';
    if (msg) setTimeout(()=>{ if(el.textContent===msg) el.textContent=''; }, 4000);
  }

  async function refreshPremiumStock() {
    const tbody = document.getElementById('premium-stock-tbody');
    if (!tbody) return;

    tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:2rem;"><i class="fas fa-spinner fa-spin"></i> Loading...</td></tr>';

    try {
      // Load products map (for names)
      const [{ data: prods, error: prodErr }, { data: rows, error: rowErr }] = await Promise.all([
        supabaseClient.from('products').select('id,name'),
        supabaseClient.from(PREMIUM_STOCK_TABLE)
          .select('id,product_id,email,password,is_premium,created_at')
          .eq('is_premium', false)
          .order('created_at', { ascending: false })
      ]);

      if (prodErr) throw prodErr;
      if (rowErr) throw rowErr;

      const prodMap = new Map((prods || []).map(p => [String(p.id), p.name]));
      const list = rows || [];

      // Apply local filters (search + product filter)
      const searchVal = (document.getElementById('premium-stock-search')?.value || '').trim().toLowerCase();
      const prodFilter = (document.getElementById('premium-stock-filter')?.value || 'all');
      let filtered = list;
      if (prodFilter && prodFilter !== 'all') {
        filtered = filtered.filter(r => String(r.product_id) === String(prodFilter));
      }
      if (searchVal) {
        filtered = filtered.filter(r => 
          String(r.email || '').toLowerCase().includes(searchVal) ||
          String(r.password || '').toLowerCase().includes(searchVal)
        );
      }

      const displayList = filtered;

      if (!displayList.length) {
        tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:2rem; opacity:.7;">No basic accounts in premium stock.</td></tr>';
        return;
      }

      tbody.innerHTML = displayList.map((r, i) => {
        const pname = prodMap.get(String(r.product_id)) || `Product #${r.product_id}`;
        return `
          <tr>
            <td>${i+1}</td>
            <td style="max-width:160px; word-break:break-word;">${escapeHtml(pname)}</td>
            <td style="max-width:220px; word-break:break-word;">${escapeHtml(r.email || '')}</td>
            <td style="max-width:180px; word-break:break-word;">${escapeHtml(r.password || '')}</td>
            <td>
              <div style="display:flex; gap:.4rem; flex-wrap:wrap;">
                <button class="btn btn-secondary" onclick="markPremiumStock(${r.id})"><i class="fas fa-crown"></i> Premium</button>
                <button class="btn btn-danger" onclick="deletePremiumStock(${r.id})"><i class="fas fa-trash"></i> Delete</button>
              </div>
            </td>
          </tr>
        `;
      }).join('');
    } catch (err) {
      console.error('refreshPremiumStock error:', err);
      tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:2rem; color:#c0392b;">Failed to load. Check table name & RLS.</td></tr>';
      setPremiumMsg('Failed to load premium stock. Check DB table / RLS.', true);
    }
  }

  async function addPremiumStock() {
    const productId = document.getElementById('premium-product')?.value;
    const email = (document.getElementById('premium-email')?.value || '').trim();
    const password = (document.getElementById('premium-pass')?.value || '').trim();

    if (!productId) return setPremiumMsg('Select product.', true);
    if (!email) return setPremiumMsg('Enter email/login.', true);
    if (!password) return setPremiumMsg('Enter password.', true);

    try {
      const { error } = await supabaseClient
        .from(PREMIUM_STOCK_TABLE)
        .insert([{ product_id: Number(productId), email, password }]);

      if (error) throw error;

      document.getElementById('premium-email').value = '';
      document.getElementById('premium-pass').value = '';
      setPremiumMsg('Added to premium stock ✅');
      refreshPremiumStock();
    } catch (err) {
      console.error('addPremiumStock error:', err);
      setPremiumMsg('Add failed. Check table / RLS.', true);
    }
  }

  async function markPremiumStock(id) {
    if (!confirm('Mark as premium and remove from list?')) return;
    try {
      const { error } = await supabaseClient
        .from(PREMIUM_STOCK_TABLE)
        .update({ is_premium: true, premium_at: new Date().toISOString() })
        .eq('id', id);

      if (error) throw error;
      setPremiumMsg('Removed (premium) ✅');
      refreshPremiumStock();
    } catch (err) {
      console.error('markPremiumStock error:', err);
      setPremiumMsg('Update failed. Check RLS.', true);
    }
  }

  async function deletePremiumStock(id) {
    if (!confirm('Delete this basic account from premium stock?')) return;
    try {
      const { error } = await supabaseClient
        .from(PREMIUM_STOCK_TABLE)
        .delete()
        .eq('id', id);

      if (error) throw error;
      setPremiumMsg('Deleted ✅');
      refreshPremiumStock();
    } catch (err) {
      console.error('deletePremiumStock error:', err);
      setPremiumMsg('Delete failed. Check RLS.', true);
    }
  }

  async function initPremiumStockPanel() {
    await populatePremiumProducts();

    // Build filter dropdown (All Products + list)
    const filter = document.getElementById('premium-stock-filter');
    if (filter) {
      const current = filter.value || 'all';
      filter.innerHTML = '<option value="all">All Products</option>' + (ownerProducts || [])
        .filter(p => p.active !== false)
        .map(p => `<option value="${p.id}">${escapeHtml(p.name || ('Product #' + p.id))}</option>`)
        .join('');
      filter.value = current || 'all';
      if (!filter.dataset.bound) {
        filter.addEventListener('change', () => refreshPremiumStock());
        filter.dataset.bound = '1';
      }
    }

    const search = document.getElementById('premium-stock-search');
    if (search && !search.dataset.bound) {
      let t;
      search.addEventListener('input', () => {
        clearTimeout(t);
        t = setTimeout(() => refreshPremiumStock(), 250);
      });
      search.dataset.bound = '1';
    }

    await refreshPremiumStock();
  }

  // ---------- Initialize Owner App ----------
// I-update ang sidebar navigation sa initOwnerApp function
function initOwnerApp() {
  console.log('Initializing owner app...');
  
  // Setup date filters
  setupDateFilters();
  
  // Setup form handlers
  setupFormHandlers();
  
  // Load initial data
  loadProductsAndPlans().then(() => {
    console.log('Products and plans loaded:', ownerProducts.length, 'products,', ownerPlans.length, 'plans');
    
    // Populate dropdowns
    populateAddStockDropdowns();
    populateManualDropdowns();
    
    // Populate product filters in records
    populateProductFilters();
    
    // Load dashboard first
    // Populate Premium Stock products dropdown (for the Basic Accounts section)
    populatePremiumProducts();

    // Load the currently active panel (important when the page is refreshed while not on Dashboard)
    const activePanelEl = document.querySelector('.content-panel.active');
    const activePanelName = activePanelEl ? activePanelEl.id.replace(/-panel$/, '') : 'dashboard';
    loadPanelData(activePanelName);
// FIXED: Remove checkboxes from sidebar - use proper button styling
    setupSidebarNavigation();
    
  }).catch(error => {
    console.error('Error loading initial data:', error);
    showMessage('msg-add', 'Error loading initial data. Please refresh the page.', 'error');
  });
}

// NEW FUNCTION: Setup proper sidebar navigation without checkboxes
function setupSidebarNavigation() {
  const navButtons = document.querySelectorAll('.nav-btn');
  
  navButtons.forEach(btn => {
    // Remove any existing checkbox or icon before text
    btn.innerHTML = btn.innerHTML.replace(/<i class="fas fa-[^"]+"><\/i>\s*/, '');
    
    // Get the panel name
    const panelName = btn.getAttribute('data-panel');
    
    // Add appropriate icon based on panel
    let icon = '';
    switch(panelName) {
      case 'dashboard':
        icon = '<i class="fas fa-tachometer-alt"></i>';
        break;
      case 'add-stock':
        icon = '<i class="fas fa-plus-circle"></i>';
        break;
      case 'manage-stock':
        icon = '<i class="fas fa-edit"></i>';
        break;
      case 'sold-stock':
        icon = '<i class="fas fa-check-circle"></i>';
        break;
      case 'all-records':
        icon = '<i class="fas fa-list"></i>';
        break;
      case 'auto-records':
        icon = '<i class="fas fa-robot"></i>';
        break;
      case 'manual-records':
        icon = '<i class="fas fa-user-edit"></i>';
        break;
      case 'add-record':
        icon = '<i class="fas fa-plus-square"></i>';
        break;
      case 'rules':
        icon = '<i class="fas fa-ruler-combined"></i>';
        break;
      default:
        icon = '<i class="fas fa-circle"></i>';
    }
    
    // Update button HTML
    btn.innerHTML = `${icon} ${btn.textContent}`;
    
    // Add click event
    btn.addEventListener('click', function(e) {
      e.preventDefault();
      
      // Update active state
      navButtons.forEach(b => b.classList.remove('active'));
      this.classList.add('active');
      
      // Close sidebar on mobile
      if (window.innerWidth < 1024) {
        closeSidebar();
      }
      
      // Show corresponding panel
      const panelId = this.getAttribute('data-panel') + '-panel';
      document.querySelectorAll('.content-panel').forEach(p => {
        p.classList.remove('active');
      });
      
      const targetPanel = document.getElementById(panelId);
      if (targetPanel) {
        targetPanel.classList.add('active');
        
        // Load data for the panel
        loadPanelData(panelId);
        
        // Scroll to top
        setTimeout(() => {
          const mainContent = document.getElementById('main-content');
          if (mainContent) {
            mainContent.scrollTo(0, 0);
          }
        }, 100);
      }
    });
  });
}

  function setupFormHandlers() {
    // Add Stock Form
    const addStockForm = document.getElementById('addStockForm');
    if (addStockForm) {
      addStockForm.addEventListener('submit', handleAddStockSubmit);
    }
    
    // Edit Stock Form
    const editStockForm = document.getElementById('editStockForm');
    if (editStockForm) {
      editStockForm.addEventListener('submit', handleEditStockSubmit);
    }
    
    // Manual Record Form
    const manualRecordForm = document.getElementById('manualRecordForm');
    if (manualRecordForm) {
      manualRecordForm.addEventListener('submit', handleManualRecordSubmit);
    }
    
    // Rules Form
    const rulesForm = document.getElementById('rulesForm');
    if (rulesForm) {
      rulesForm.addEventListener('submit', handleAddRule);
    }
    
    // Manage product filter
    const manageFilter = document.getElementById('manage-product-filter');
    if (manageFilter) {
      manageFilter.addEventListener('change', handleManageProductFilter);
    }
    
    // Date filters
    const recordsPeriod = document.getElementById('records-period');
    if (recordsPeriod) {
      recordsPeriod.addEventListener('change', handlePeriodChange);
    }
    
    const recordsPlatform = document.getElementById('records-platform');
    if (recordsPlatform) {
      recordsPlatform.addEventListener('change', handlePlatformChange);
    }
    
    // FIXED: Product filter for records
    const recordsProduct = document.getElementById('records-product');
    if (recordsProduct) {
      recordsProduct.addEventListener('change', function() {
        loadRecordsAll();
      });
    }
    
    const specificDate = document.getElementById('records-specific-date');
    if (specificDate) {
      specificDate.addEventListener('change', handleSpecificDateChange);
    }
    
    // Auto records period filter
    const autoRecordsPeriod = document.getElementById('auto-records-period');
    if (autoRecordsPeriod) {
      autoRecordsPeriod.addEventListener('change', function() {
        loadRecordsAuto();
      });
    }
    
    // Auto records product filter
    const autoRecordsProduct = document.getElementById('auto-records-product');
    if (autoRecordsProduct) {
      autoRecordsProduct.addEventListener('change', function() {
        loadRecordsAuto();
      });
    }
    
    // Manual records period filter
    const manualRecordsPeriod = document.getElementById('manual-records-period');
    if (manualRecordsPeriod) {
      manualRecordsPeriod.addEventListener('change', function() {
        loadRecordsManual();
      });
    }
    
    // Manual records product filter
    const manualRecordsProduct = document.getElementById('manual-records-product');
    if (manualRecordsProduct) {
      manualRecordsProduct.addEventListener('change', function() {
        loadRecordsManual();
      });
    }
  }

  function setupDateFilters() {
    // Set today as default
    const today = new Date().toISOString().split('T')[0];
    const dateAvailed = document.getElementById('manual-date-availed');
    const specificDate = document.getElementById('records-specific-date');
    
    if (dateAvailed) {
      dateAvailed.value = today;
    }
    if (specificDate) {
      specificDate.value = today;
    }
  }

  // ---------- Filter Handlers ----------
  function handleManageProductFilter() {
    loadManageStocks();
  }

  function handlePeriodChange() {
    const period = this.value;
    
    if (period === 'custom') {
      const customDateGroup = document.getElementById('custom-date-group');
      if (customDateGroup) {
        customDateGroup.style.display = 'block';
      }
    } else {
      const customDateGroup = document.getElementById('custom-date-group');
      if (customDateGroup) {
        customDateGroup.style.display = 'none';
      }
    }
    
    loadRecordsAll();
  }

  function handlePlatformChange() {
    loadRecordsAll();
  }

  function handleSpecificDateChange() {
    loadRecordsAll();
  }

  // ---------- Helper Functions ----------
  function showMessage(elementId, message, type = 'info') {
    const element = document.getElementById(elementId);
    if (!element) return;
    
    let icon = '';
    switch(type) {
      case 'success':
        icon = '<i class="fas fa-check-circle"></i>';
        break;
      case 'error':
        icon = '<i class="fas fa-exclamation-circle"></i>';
        break;
      default:
        icon = '<i class="fas fa-info-circle"></i>';
    }
    
    element.innerHTML = `
      <div class="message message-${type}">
        ${icon} ${message}
      </div>
    `;
    
    // Auto-hide success messages after 3 seconds
    if (type === 'success') {
      setTimeout(() => {
        element.innerHTML = '';
      }, 3000);
    }
  }

  function findPlan(productId, planType, duration) {
    // If duration is "Any Duration", return null because we don't need a specific plan
    if (duration === 'Any Duration') {
      return null;
    }
    
    // FOR ALL PLAN TYPES: If duration is "Any Duration"
    if (duration === 'Any Duration') {
      // Find any plan with the same product_id and plan_type (regardless of duration)
      return ownerPlans.find(
        pl => pl.product_id === productId &&
              pl.plan_type === planType
      ) || null;
    }
    // Normal case for specific durations
    return ownerPlans.find(
      pl => pl.product_id === productId &&
            pl.plan_type === planType &&
            pl.duration === duration
    ) || null;
  }

  // ---------- Load Products and Plans ----------
  async function loadProductsAndPlans() {
    try {
      // Load products
      const { data: prodData, error: prodErr } = await supabaseClient
        .from('products')
        .select('id, name')
        .eq('active', true)
        .order('id', { ascending: true });

      if (prodErr) throw prodErr;
      ownerProducts = prodData || [];

      // Load plans
      const { data: planData, error: planErr } = await supabaseClient
        .from('product_plans')
        .select('id, product_id, plan_type, duration, price, price_reseller, active')
        .eq('active', true)
        .order('id', { ascending: true });

      if (planErr) throw planErr;
      ownerPlans = planData || [];

      return { products: ownerProducts, plans: ownerPlans };
    } catch (error) {
      console.error('Error loading products and plans:', error);
      showMessage('msg-add', 'Error loading products and plans', 'error');
      return { products: [], plans: [] };
    }
  }

  // ---------- Populate Product Filters ----------
  function populateProductFilters() {
    const productFilters = [
      'records-product',
      'auto-records-product',
      'manual-records-product',
      'manage-product-filter',
      'rules-product'
    ];
    
    productFilters.forEach(filterId => {
      const filter = document.getElementById(filterId);
      if (filter) {
        // Save current value if exists
        const currentValue = filter.value;
        filter.innerHTML = '<option value="all">All Products</option>';
        ownerProducts.forEach(product => {
          const option = document.createElement('option');
          option.value = product.id;
          option.textContent = product.name;
          filter.appendChild(option);
        });
        // Restore current value if still exists
        if (currentValue && Array.from(filter.options).some(opt => opt.value === currentValue)) {
          filter.value = currentValue;
        }
      }
    });
  }

  // ---------- Dashboard Functions ----------
  async function loadDashboard() {
    try {
      // Load today's sales
      const today = new Date();
      const todayStart = new Date(today.getFullYear(), today.getMonth(), today.getDate());
      const todayEnd = new Date(today.getFullYear(), today.getMonth(), today.getDate() + 1);

      // Fetch records for today
      const { data: todayRecords, error: todayErr } = await fetchUnifiedRecords();
      
      if (!todayErr) {
        // Filter for today only
        const todayFiltered = (todayRecords || []).filter(r => {
          const recordDate = r.date_availed || r.used_at || r.created_at;
          if (!recordDate) return false;
          const date = new Date(recordDate);
          return date >= todayStart && date < todayEnd;
        });
        
        updateRecentSalesTable(todayFiltered);
        
        // Update stats cards - FIXED
        updateDashboardStats(todayFiltered);
      }

      // Load available stocks count - FIXED QUERY
      const { data: stocks, error: stocksErr } = await supabaseClient
        .from('product_plan_stocks')
        .select(`
          id,
          is_used,
          product_id,
          product_plans!left(
            plan_type,
            duration
          )
        `)
        .eq('is_used', false);

      if (!stocksErr && stocks) {
        updateLowStockTable(stocks);
        // Update available stocks count in stats
        const statsAvailable = document.getElementById('stats-available');
        if (statsAvailable) statsAvailable.textContent = stocks.length;
      }
      
    } catch (error) {
      console.error('Error loading dashboard:', error);
    }
  }

  function updateRecentSalesTable(records) {
    const tbody = document.querySelector('#recent-sales tbody');
    if (!tbody) return;
    
    if (!records || records.length === 0) {
      tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 2rem;">No recent sales today</td></tr>';
      return;
    }

    let html = '';
    // Take only last 10 records
    records.slice(0, 10).forEach(record => {
      const date = record.date_availed ? 
        new Date(record.date_availed).toLocaleDateString('en-PH', { 
          month: 'short', 
          day: 'numeric',
          hour: '2-digit',
          minute: '2-digit'
        }) : '-';
      
      // Get product name from ownerProducts array
      const product = ownerProducts.find(p => p.id === record.product_id);
      const productName = product ? product.name : record.product_name || 'Unknown';
      
      html += `
        <tr>
          <td>#${record.record_id || record.order_id || '-'}</td>
          <td>${record.buyer_name || 'Unknown'}</td>
          <td>${productName}</td>
          <td>₱${record.price ? Number(record.price).toFixed(2) : '0.00'}</td>
          <td>${date}</td>
        </tr>
      `;
    });
    
    tbody.innerHTML = html;
  }

  function updateLowStockTable(stocks) {
    // Group by product with product names
    const productCounts = {};
    stocks.forEach(stock => {
      const product = ownerProducts.find(p => p.id === stock.product_id);
      const productName = product ? product.name : `Product #${stock.product_id}`;
      productCounts[productName] = (productCounts[productName] || 0) + 1;
    });

    const tbody = document.querySelector('#low-stock tbody');
    if (!tbody) return;
    
    if (Object.keys(productCounts).length === 0) {
      tbody.innerHTML = '<tr><td colspan="2" style="text-align: center; padding: 2rem;">No stock data available</td></tr>';
      return;
    }

    let html = '';
    Object.entries(productCounts).forEach(([product, count]) => {
      const status = count <= 3 ? 
        '<span class="badge badge-auto" style="background: linear-gradient(135deg, #ff6666, #ff3333); color: white;">Low</span>' : 
        count <= 10 ? '<span class="badge badge-manual" style="background: linear-gradient(135deg, #ffb366, #ff9933); color: white;">Medium</span>' : 
        '<span class="badge badge-available">Good</span>';
      
      html += `
        <tr>
          <td><strong>${product}</strong></td>
          <td>${count} ${status}</td>
        </tr>
      `;
    });
    
    tbody.innerHTML = html;
  }

  // FIXED: Update dashboard stats function
  async function updateDashboardStats(records = []) {
    // Auto sales count
    const autoSales = records.filter(r => r.source === 'AUTO').length;
    const statsAuto = document.getElementById('stats-auto');
    if (statsAuto) statsAuto.textContent = autoSales;
    
    // Manual sales count
    const manualSales = records.filter(r => r.source === 'MANUAL').length;
    const statsManual = document.getElementById('stats-manual');
    if (statsManual) statsManual.textContent = manualSales;
    
    // Total revenue
    const totalRevenue = records.reduce((sum, r) => sum + (Number(r.price) || 0), 0);
    const statsRevenue = document.getElementById('stats-revenue');
    if (statsRevenue) statsRevenue.textContent = `₱${totalRevenue.toFixed(2)}`;
    
    // Available stocks count - fetch separately
    const { data: availableStocks, error: stocksErr } = await supabaseClient
      .from('product_plan_stocks')
      .select('id', { count: 'exact' })
      .eq('is_used', false);

    if (!stocksErr && availableStocks) {
      const statsAvailable = document.getElementById('stats-available');
      if (statsAvailable) statsAvailable.textContent = availableStocks.length;
    }
  }

  function refreshDashboard() {
    loadDashboard();
    showMessage('msg-add', 'Dashboard refreshed successfully', 'success');
  }

  // ---------- Add Stock Functions ----------
  function populateAddStockDropdowns() {
    const productSel = document.getElementById('stock-product');
    const typeSel = document.getElementById('stock-type');
    const durationSel = document.getElementById('stock-duration');

    if (!productSel || !typeSel || !durationSel) return;

    // Clear existing options
    productSel.innerHTML = '<option value="">Select Product</option>';
    typeSel.innerHTML = '<option value="">Select Plan Type</option>';
    durationSel.innerHTML = '<option value="">Select Duration</option>';

    // Populate products
    if (ownerProducts.length === 0) {
      productSel.innerHTML = '<option value="">No products available</option>';
      return;
    }

    ownerProducts.forEach(p => {
      const opt = document.createElement('option');
      opt.value = String(p.id);
      opt.textContent = p.name;
      productSel.appendChild(opt);
    });

    // Setup change events
    productSel.onchange = refreshTypesAndDurations;
    typeSel.onchange = refreshDurationsOnly;

    // Initial population
    refreshTypesAndDurations();

    function refreshTypesAndDurations() {
      const productId = Number(productSel.value);
      if (!productId) {
        typeSel.innerHTML = '<option value="">Select Plan Type</option>';
        durationSel.innerHTML = '<option value="">Select Duration</option>';
        return;
      }

      const plansForProduct = ownerPlans.filter(pl => pl.product_id === productId);
      const types = [...new Set(plansForProduct.map(pl => pl.plan_type))];
      
      typeSel.innerHTML = '<option value="">Select Plan Type</option>';
      types.forEach(t => {
        const opt = document.createElement('option');
        opt.value = t;
        opt.textContent = t;
        typeSel.appendChild(opt);
      });
      
      refreshDurationsOnly();
    }

    function refreshDurationsOnly() {
      const productId = Number(productSel.value);
      const planType = typeSel.value;
      
      if (!productId || !planType) {
        durationSel.innerHTML = '<option value="">Select Duration</option>';
        return;
      }

      const plansForType = ownerPlans.filter(
        pl => pl.product_id === productId && pl.plan_type === planType
      );
      
      durationSel.innerHTML = '<option value="">Select Duration</option>';
      
      // FOR ALL PLAN TYPES: Add "Any Duration" option
      // Check if "Any Duration" already exists in plans
      const anyDurationExists = plansForType.some(pl => 
        pl.duration.toLowerCase().includes('any')
      );
      
      if (!anyDurationExists) {
        // Add "Any Duration" as the first option for ALL plan types
        const opt = document.createElement('option');
        opt.value = 'Any Duration';
        opt.textContent = 'Any Duration';
        durationSel.appendChild(opt);
      }
      
      // Add all other durations from plans
      plansForType.forEach(pl => {
        const price = pl.price_regular != null ? pl.price_regular : (pl.price || 0);
        const opt = document.createElement('option');
        opt.value = pl.duration;
        opt.textContent = `${pl.duration} — ₱${Number(price).toFixed(2)}`;
        durationSel.appendChild(opt);
      });
    }
  }

  async function handleAddStockSubmit(e) {
    e.preventDefault();
    showMessage('msg-add', 'Adding stock...', 'info');

    const productId = Number(document.getElementById('stock-product').value);
    const planType = document.getElementById('stock-type').value;
    const duration = document.getElementById('stock-duration').value;
    const qty = Number(document.getElementById('stock-qty').value || 1);
    const email = document.getElementById('stock-email').value.trim();
    const password = document.getElementById('stock-password').value.trim();
    const profile = document.getElementById('stock-profile').value.trim();
    const pin = document.getElementById('stock-pin').value.trim();
    const archDays = Number(document.getElementById('stock-arch').value || 30);
    const premDate = document.getElementById('stock-premdate').value || null;

    // Validate required fields
    if (!productId || !planType || !duration || !email || !password) {
      showMessage('msg-add', 'Please fill in all required fields', 'error');
      return;
    }

    const isAny = (duration === 'Any Duration');

    // For non-ANY durations, kailangan pa rin natin ng planRow
    let planRow = null;
    let planId = null;

    if (!isAny) {
      planRow = findPlan(productId, planType, duration);
      if (!planRow) {
        showMessage('msg-add', 'No matching plan found for selected product, type, and duration', 'error');
        return;
      }
      planId = planRow.id;
    } else {
      // For "Any Duration", planId should be NULL
      planId = null;
    }

    try {
      const rows = [];
      for (let i = 0; i < qty; i++) {
        rows.push({
          product_id: productId,
          plan_id: planId,   // NULL for "Any Duration", specific ID for others
          plan_type: planType, // <-- IMPORTANT: Always save the plan_type
          email,
          password,
          profile: profile || null,
          pin: pin || null,
          auto_archive_days: archDays || null,
          premium_until: premDate || null
        });
      }

      const { error } = await supabaseClient
        .from('product_plan_stocks')
        .insert(rows);

      if (error) throw error;

      const stockTypeLabel = isAny ? 'ANY (shared pool) stock item(s)' : 'stock item(s)';
      showMessage('msg-add', `Successfully added ${qty} ${stockTypeLabel}`, 'success');

      // Reset form
      document.getElementById('stock-email').value = '';
      document.getElementById('stock-password').value = '';
      document.getElementById('stock-profile').value = '';
      document.getElementById('stock-pin').value = '';
      document.getElementById('stock-qty').value = '1';
      document.getElementById('stock-arch').value = '30';
      document.getElementById('stock-premdate').value = '';

      // Refresh views
      loadDashboard();
      loadManageStocks();
    } catch (err) {
      console.error('Error adding stock:', err);
      showMessage('msg-add', 'Error saving stock. Please check your data.', 'error');
    }
  }

  // ---------- Manage Stocks Functions (Grouped View) ----------
  async function loadManageStocks() {
    const productFilter = document.getElementById('manage-product-filter');
    const filterValue = productFilter ? productFilter.value : 'all';
    const manageList = document.getElementById('manage-list');
    
    if (!manageList) return;
    
    manageList.innerHTML = '<div style="text-align:center;padding:2rem;"><i class="fas fa-spinner fa-spin"></i> Loading stocks...</div>';

    try {
      // FIXED QUERY: Simplified query without complex joins
      let query = supabaseClient
        .from('product_plan_stocks')
        .select(`
          id,
          product_id,
          plan_id,
          plan_type,
          email,
          password,
          profile,
          pin,
          auto_archive_days,
          premium_until,
          created_at,
          is_used
        `)
        .eq('is_used', false)
        .order('created_at', { ascending: true });

      const { data, error } = await query;

      if (error) throw error;

      if (!data || data.length === 0) {
        manageList.innerHTML = '<div class="message message-info">No available stocks found</div>';
        return;
      }

      // Group stocks by email, password, product, plan type, and duration
      const groupedStocks = groupStocks(data, filterValue);
      
      // Render grouped stocks
      renderGroupedStocks(groupedStocks, filterValue);

    } catch (e) {
      console.error('Error loading manage stocks:', e);
      manageList.innerHTML = '<div class="message message-error">Error loading stocks</div>';
    }
  }

  function groupStocks(stocks, filterValue) {
    const groups = {};
    
    stocks.forEach(stock => {
      // Get product name from ownerProducts array
      const product = ownerProducts.find(p => p.id === stock.product_id);
      const productName = product ? product.name : `Product #${stock.product_id}`;
      
      // Apply product filter
      if (filterValue !== 'all' && stock.product_id != filterValue) {
        return;
      }
      
      // Create a unique key for grouping
      const key = `${stock.product_id}-${stock.plan_type}-${stock.email}-${stock.password}-${stock.profile || ''}-${stock.pin || ''}-${stock.premium_until || ''}`;
      
      if (!groups[key]) {
        groups[key] = {
          ids: [],
          count: 0,
          product_id: stock.product_id,
          product_name: productName,
          plan_type: stock.plan_type,
          duration: 'N/A', // We don't have duration in stock table
          email: stock.email,
          password: stock.password,
          profile: stock.profile,
          pin: stock.pin,
          premium_until: stock.premium_until,
          auto_archive_days: stock.auto_archive_days
        };
      }
      
      groups[key].ids.push(stock.id);
      groups[key].count++;
    });
    
    return Object.values(groups);
  }

  function renderGroupedStocks(groups, filterValue) {
    const manageList = document.getElementById('manage-list');
    
    if (!groups || groups.length === 0) {
      manageList.innerHTML = '<div class="message message-info">No stocks found</div>';
      return;
    }

    let html = '';
    
    // Group by product for better organization
    const productsMap = {};
    groups.forEach(group => {
      if (!productsMap[group.product_name]) {
        productsMap[group.product_name] = [];
      }
      productsMap[group.product_name].push(group);
    });

    Object.entries(productsMap).forEach(([productName, productGroups]) => {
      html += `
        <div class="product-group">
          <div class="product-header">
            <h4>${productName}</h4>
            <div class="product-count">${productGroups.length} groups</div>
          </div>
          <div class="product-body open">
      `;
      
      productGroups.forEach(group => {
        const premiumDate = group.premium_until ? 
          new Date(group.premium_until).toLocaleDateString('en-PH') : '-';
        
        html += `
          <div class="stock-group-item">
            <div class="stock-group-header">
              <div>
                <strong>${group.email}</strong>
                <div style="font-size: 0.8rem; color: var(--text-medium); margin-top: 0.25rem;">
                  ${group.plan_type} • ${group.duration}
                </div>
              </div>
              <span class="badge badge-quantity">${group.count}</span>
            </div>
            
            <div class="stock-group-details">
              <div><strong>Password:</strong> ${group.password || 'N/A'}</div>
              ${group.profile ? `<div><strong>Profile:</strong> ${group.profile}</div>` : ''}
              ${group.pin ? `<div><strong>PIN:</strong> ${group.pin}</div>` : ''}
              ${group.premium_until ? `<div><strong>Premium Until:</strong> ${premiumDate}</div>` : ''}
              ${group.auto_archive_days ? `<div><strong>Auto-archive:</strong> ${group.auto_archive_days} days</div>` : ''}
            </div>
            
            <div class="stock-group-actions">
              <button class="btn btn-sm btn-secondary" onclick="startEditStockGroup(${JSON.stringify(group.ids)})">
                <i class="fas fa-edit"></i> Edit Group
              </button>
              <button class="btn btn-sm btn-secondary" onclick="deleteStockGroup(${JSON.stringify(group.ids)})" style="background: var(--danger);">
                <i class="fas fa-trash"></i> Delete Group
              </button>
            </div>
          </div>
        `;
      });
      
      html += `
          </div>
        </div>
      `;
    });

    manageList.innerHTML = html;
  }

  async function startEditStockGroup(stockIds) {
    try {
      // Load the first stock's data
      const { data, error } = await supabaseClient
        .from('product_plan_stocks')
        .select('*')
        .eq('id', stockIds[0])
        .maybeSingle();

      if (error) throw error;
      if (!data) {
        showMessage('msg-edit-stock', 'Stock not found', 'error');
        return;
      }

      // Populate form
      document.getElementById('edit-ids').value = JSON.stringify(stockIds);
      document.getElementById('edit-email').value = data.email || '';
      document.getElementById('edit-password').value = data.password || '';
      document.getElementById('edit-profile').value = data.profile || '';
      document.getElementById('edit-pin').value = data.pin || '';
      document.getElementById('edit-arch').value = data.auto_archive_days || '';
      document.getElementById('edit-premdate').value = data.premium_until ? 
        data.premium_until.substring(0, 10) : '';

      // Show edit form
      const editForm = document.getElementById('edit-stock-form');
      if (editForm) {
        editForm.style.display = 'block';
        editForm.scrollIntoView({ behavior: 'smooth' });
      }
    } catch (error) {
      console.error('Error loading stock for edit:', error);
      showMessage('msg-edit-stock', 'Error loading stock for edit', 'error');
    }
  }

  async function handleEditStockSubmit(e) {
    e.preventDefault();
    showMessage('msg-edit-stock', 'Saving changes...', 'info');

    const stockIds = JSON.parse(document.getElementById('edit-ids').value);
    const email = document.getElementById('edit-email').value.trim();
    const password = document.getElementById('edit-password').value.trim();
    const profile = document.getElementById('edit-profile').value.trim();
    const pin = document.getElementById('edit-pin').value.trim();
    const arch = document.getElementById('edit-arch').value;
    const premDate = document.getElementById('edit-premdate').value || null;

    try {
      const { error } = await supabaseClient
        .from('product_plan_stocks')
        .update({
          email,
          password,
          profile: profile || null,
          pin: pin || null,
          auto_archive_days: arch === '' ? null : Number(arch),
          premium_until: premDate
        })
        .in('id', stockIds);

      if (error) throw error;

      showMessage('msg-edit-stock', 'Stock group updated successfully', 'success');
      loadManageStocks();
      
      // Hide form after delay
      setTimeout(() => {
        document.getElementById('edit-stock-form').style.display = 'none';
        document.getElementById('msg-edit-stock').innerHTML = '';
      }, 2000);
    } catch (error) {
      console.error('Error updating stock:', error);
      showMessage('msg-edit-stock', 'Error saving changes', 'error');
    }
  }

  async function deleteStockGroup(stockIds) {
    if (!confirm('Are you sure you want to delete this stock group?')) return;

    try {
      const { error } = await supabaseClient
        .from('product_plan_stocks')
        .delete()
        .in('id', stockIds);

      if (error) throw error;

      showMessage('msg-edit-stock', 'Stock group deleted successfully', 'success');
      loadManageStocks();
    } catch (error) {
      console.error('Error deleting stock group:', error);
      showMessage('msg-edit-stock', 'Error deleting stock group', 'error');
    }
  }

  function cancelEditStock() {
    document.getElementById('edit-stock-form').style.display = 'none';
    document.getElementById('msg-edit-stock').innerHTML = '';
  }

  // ---------- Sold Stocks Functions (Card View) ----------
async function loadSoldStocks() {
    const soldList = document.getElementById('sold-list');
    if (!soldList) return;

    soldList.innerHTML = '<div style="text-align: center; padding: 2rem;"><i class="fas fa-spinner fa-spin"></i> Loading sold accounts...</div>';

    try {
      // Use unified records so values (buyer, duration, price) are accurate.
      const { data, error } = await fetchUnifiedRecords();
      if (error) throw error;

      renderSoldCards(data || []);
    } catch (error) {
      console.error('Error loading sold stocks:', error);
      soldList.innerHTML = '<div class="message message-error">Error loading sold accounts</div>';
    }
  }

// UPDATE: renderSoldCards function para mag-match sa reference image
function renderSoldCards(records) {
  const soldList = document.getElementById('sold-list');
  
  // Calculate summary statistics
  let autoCount = 0;
  let manualCount = 0;
  let totalRevenue = 0;
  
  records.forEach(record => {
    if (record.source === 'AUTO') {
      autoCount++;
    } else {
      manualCount++;
    }
    
    // Add to total revenue
    if (record.price) {
      totalRevenue += Number(record.price);
    }
  });
  
  // Update summary cards
  const soldAutoCount = document.getElementById('sold-auto-count');
  const soldManualCount = document.getElementById('sold-manual-count');
  const soldTotalCount = document.getElementById('sold-total-count');
  const soldTotalRevenue = document.getElementById('sold-total-revenue');
  
  if (soldAutoCount) soldAutoCount.textContent = autoCount;
  if (soldManualCount) soldManualCount.textContent = manualCount;
  if (soldTotalCount) soldTotalCount.textContent = records.length;
  if (soldTotalRevenue) soldTotalRevenue.textContent = `₱${totalRevenue.toFixed(2)}`;
  
  // FIXED: Card layout to match reference image
  let html = '<div class="sold-cards-grid">';
  
  records.forEach(record => {
    const soldDateRaw = pickFirst(record.date_availed, record.used_at, record.sold_at, record.created_at, record.date_sold, record.sold_date);
  const soldDate = formatDateAny(soldDateRaw) || 'N/A';
    
    // FIXED: Get product type (Shared Profile/Solo Account) from plan_type
    const productType = record.plan_type || 'Shared Profile';
    const isSoloAccount = productType.toLowerCase().includes('solo') || 
                         productType.toLowerCase().includes('personal');
    
    const typeBadge = isSoloAccount ? 
      '<span class="badge" style="background: linear-gradient(135deg, #5cd6a9, #33cc99); color: white; font-size: 0.7rem; padding: 0.2rem 0.5rem;">Solo Account</span>' : 
      '<span class="badge" style="background: linear-gradient(135deg, #85a3ff, #668cff); color: white; font-size: 0.7rem; padding: 0.2rem 0.5rem;">Shared Profile</span>';
    
    // FIXED: TG Bot badge
    const sourceBadge = record.source === 'AUTO' ? 
      '<span class="badge badge-auto" style="background: linear-gradient(135deg, #ff85b3, #ff66a3); color: white;">TG Bot</span>' : 
      '<span class="badge badge-manual" style="background: linear-gradient(135deg, #ffb366, #ff9933); color: white;">Manual</span>';
    
    // FIXED: Get buyer info for TG Bot sales
    let buyerInfo = '';
    if (record.source === 'AUTO') {
      // Try to get real buyer info from TG Bot
      buyerInfo = record.buyer_telegram_id ? 
                 `TG: @${record.buyer_telegram_id}` : 
                 'TG Bot Buyer';
    } else {
      buyerInfo = record.buyer_name || 'Unknown';
    }
    
    // Email / expiry fallbacks (some schemas store these in different columns)
    const email = pickFirst(record.account_email, record.stock_email, record.login_email, record.email, record.account) || 'N/A';

    const expiryRawCard = pickFirst(record.new_expiry, record.expiry_date, record.expiry, record.expires_at, record.expiration_date, record.expiryDate, record.newExpiry);
    const expiryDate = formatDateAny(expiryRawCard) || 'N/A';
    
    html += `
      <div class="sold-card">
        <div class="sold-card-header">
          <div>
            <h4 class="sold-card-title">${record.product_name || 'Unknown'}</h4>
            <p class="sold-card-subtitle">${productType}</p>
          </div>
          ${sourceBadge}
        </div>
        
        <div class="sold-card-details">
          <div><strong>Buyer:</strong> <span>${buyerInfo}</span></div>
          <div><strong>Email:</strong> <span>${email}</span></div>
          <div><strong>Duration:</strong> <span>${record.duration || 'N/A'}</span></div>
          <div><strong>Expiry:</strong> <span>${expiryDate}</span></div>
          <div><strong>Price:</strong> <span>${record.price ? `₱${Number(record.price).toFixed(2)}` : 'N/A'}</span></div>
          <div><strong>Sold:</strong> <span>${soldDate}</span></div>
        </div>
      </div>
    `;
  });
  
  html += '</div>';
  soldList.innerHTML = html;
}
  // UPDATE: showSoldDetails function para sa TG Bot buyer info
function showSoldDetails(record) {
  const soldDateRaw = pickFirst(record.date_availed, record.used_at, record.sold_at, record.created_at, record.date_sold, record.sold_date);
  const soldDate = formatDateAny(soldDateRaw) || 'N/A';
  
  const expiryRaw = pickFirst(record.new_expiry, record.expiry_date, record.expiry, record.expires_at, record.expiration_date, record.expiryDate, record.newExpiry);
  const expiryDate = formatDateAny(expiryRaw) || 'N/A';
  
  const sourceBadge = record.source === 'AUTO' ? 
    '<span class="badge badge-auto">TG Bot Sale</span>' : 
    '<span class="badge badge-manual">Manual Sale</span>';
  
  // FIXED: Get buyer info - prefer real data from order_data
  let buyerName = record.buyer_name || record.buyerName || 'Buyer';
    let buyerTelegram = 'N/A';
    if (record.buyer_telegram_username) buyerTelegram = '@' + record.buyer_telegram_username;
    else if (record.buyer_telegram_id) buyerTelegram = '@' + record.buyer_telegram_id;

    let buyerEmail = record.buyer_email || record.email || null;

    const accountEmail = pickFirst(
    record.account_email, record.stock_email, record.login_email, record.email,
    stockData?.email, stockData?.account_email, stockData?.login_email,
    record.login, record.login_link, record.login_url
  ) || 'N/A';

  const accountPassword = pickFirst(
    record.account_password, record.password, record.account_pass, record.pass,
    stockData?.password, stockData?.account_password, stockData?.pass
  ) || 'N/A';

  const accountProfile = pickFirst(record.account_profile, stockData?.profile, stockData?.account_profile, record.profile) || '';
  const accountPin = pickFirst(record.account_pin, stockData?.pin, stockData?.account_pin, record.pin) || '';

  const expiryRaw2 = pickFirst(expiryRaw, record.expiry, record.expiry_date, record.expires_at, stockData?.expiry_date, stockData?.expires_at, stockData?.expiry);
  const expiryDateFinal = formatDateAny(expiryRaw2) || 'N/A';

  const content = `
    <div class="detail-section">
      <h3 style="margin-top: 0; display: flex; justify-content: space-between; align-items: center;">
        <span>${record.product_name || 'Unknown Product'}</span>
        ${sourceBadge}
      </h3>
      <div style="color: var(--text-medium); margin-top: 0.5rem;">
        <span><i class="fas fa-tag"></i> ${record.plan_type || ''}</span>
      </div>
    </div>
    
    <div class="detail-section">
      <h4><i class="fas fa-user"></i> Buyer Information</h4>
      <div class="sold-card-details">
        <div><strong>Name:</strong> <span>${buyerName}</span></div>
        <div><strong>Telegram:</strong> <span>${buyerTelegram}</span></div>
        ${buyerEmail ? `<div><strong>Buyer Email:</strong> <span>${buyerEmail}</span></div>` : ''}
        <div><strong>Platform:</strong> <span>${record.platform || 'TG'}</span></div>
      </div>
    </div>
    
    <div class="detail-section">
      <h4><i class="fas fa-key"></i> Account Details</h4>
      <div class="sold-card-details">
        <div><strong>Account Email:</strong> <span>${accountEmail}</span></div>
        <div><strong>Password:</strong> <span>${accountPassword}</span></div>
        ${accountProfile ? `<div><strong>Profile:</strong> <span>${accountProfile}</span></div>` : ''}
        ${accountPin ? `<div><strong>PIN:</strong> <span>${accountPin}</span></div>` : ''}
      </div>
    </div>
    
    <div class="detail-section">
      <h4><i class="fas fa-calendar"></i> Date Information</h4>
      <div class="sold-card-details">
        <div><strong>Date Sold:</strong> <span>${soldDate}</span></div>
        <div><strong>Duration:</strong> <span>${record.duration || 'N/A'}</span></div>
        <div><strong>Expiry Date:</strong> <span>${expiryDateFinal}</span></div>
        ${record.additional_days ? `<div><strong>Additional Days:</strong> <span>${record.additional_days} days</span></div>` : ''}
      </div>
    </div>
    
    <div class="detail-section">
      <h4><i class="fas fa-money-bill-wave"></i> Payment Information</h4>
      <div class="sold-card-details">
        ${record.price ? `<div><strong>Price:</strong> <span>₱${Number(record.price).toFixed(2)}</span></div>` : ''}
        <div><strong>Record ID:</strong> <span>${record.record_id || 'N/A'}</span></div>
        ${record.stock_id ? `<div><strong>Stock ID:</strong> <span>${record.stock_id}</span></div>` : ''}
        <div><strong>Source:</strong> <span>${record.source === 'AUTO' ? 'TG Bot' : 'Manual'}</span></div>
      </div>
    </div>
    
    ${record.notes ? `
      <div class="detail-section">
        <h4><i class="fas fa-sticky-note"></i> Notes</h4>
        <div style="background: var(--pastel-gray); padding: 1rem; border-radius: 8px; font-size: 0.9rem;">
          ${record.notes}
        </div>
      </div>
    ` : ''}
    
    <div style="margin-top: 1.5rem; display: flex; gap: 0.5rem; flex-wrap: wrap;">
      ${record.source === 'AUTO' && record.stock_id ? `
        <button class="btn btn-primary" onclick="closeDetailOverlay(); startAutoExpiryEdit(${record.stock_id}, '${record.new_expiry || ''}')">
          <i class="fas fa-calendar-alt"></i> Edit Expiry
        </button>
      ` : ''}
      <button class="btn btn-secondary" onclick="closeDetailOverlay()">
        <i class="fas fa-times"></i> Close
      </button>
    </div>
  `;
  
  showDetailOverlay(content);
}
function openInlineManualSaleForm() {
    document.getElementById("inline-manual-sale-form").style.display = "block";
    populateManualDropdownsInline();
}

// DOM ELEMENTS
const inlineProduct = document.getElementById("inline-product");
const inlinePlanType = document.getElementById("inline-plantype");
const inlineDuration = document.getElementById("inline-duration");
const inlinePrice = document.getElementById("inline-price");
const inlineEmail = document.getElementById("inline-email");
const inlinePass = document.getElementById("inline-pass");

function populateManualDropdownsInline() {
    inlineProduct.innerHTML = "";
    inlinePlanType.innerHTML = "";
    inlineDuration.innerHTML = "";

    ownerProducts.forEach(p => {
        let o = document.createElement("option");
        o.value = p.id;
        o.textContent = p.name;
        inlineProduct.appendChild(o);
    });

    inlineProduct.onchange();
}

inlineProduct.onchange = () => {
    let productId = Number(inlineProduct.value);
    let plans = ownerPlans.filter(pl => pl.product_id === productId);
    let types = [...new Set(plans.map(pl => pl.plan_type))];

    inlinePlanType.innerHTML = "";
    types.forEach(t => {
        let o = document.createElement("option");
        o.value = t;
        o.textContent = t;
        inlinePlanType.appendChild(o);
    });

    inlinePlanType.onchange();
};

inlinePlanType.onchange = () => {
    let productId = Number(inlineProduct.value);
    let type = inlinePlanType.value;

    let durations = ownerPlans.filter(pl =>
        pl.product_id === productId && pl.plan_type === type
    );

    inlineDuration.innerHTML = "";
    durations.forEach(pl => {
        let o = document.createElement("option");
        o.value = pl.duration;
        o.textContent = pl.duration;
        inlineDuration.appendChild(o);
    });
};

async function saveInlineManualRecord() {
    let payload = {
        product_id: Number(inlineProduct.value),
        plan_type: inlinePlanType.value,
        duration: inlineDuration.value,
        price: Number(inlinePrice.value),
        account_email: inlineEmail.value,
        account_password: inlinePass.value || null,
        buyer_name: document.getElementById("adduser-buyer-name").value,
        buyer_telegram_id: document.getElementById("adduser-buyer-tg").value || null,
        platform: "TG",
        date_availed: document.getElementById("adduser-date-availed").value,
        new_expiry: document.getElementById("adduser-expiry-date").value,
        old_expiry: null,
        additional_days: 0
    };

    const { data, error } = await supabaseClient
        .from("manual_stock_records")
        .insert(payload)
        .select()
        .single();

    if (error) {
        alert("Manual sale error: " + error.message);
        return;
    }

    // Insert into dropdown
    const sel = document.getElementById("adduser-sale-record");
    const opt = document.createElement("option");
    opt.value = "manual_" + data.id;
    opt.textContent = `[Manual] ${data.buyer_name} - ${data.product_name}`;
    sel.appendChild(opt);

    // Auto-select it
    sel.value = "manual_" + data.id;

    // Hide inline form
    document.getElementById("inline-manual-sale-form").style.display = "none";
    
    alert("Manual record created and linked!");
}

  // ---------- Auto Expiry Functions (Updated with Add Days) ----------
  function startAutoExpiryEdit(stockId, currentExpiry = '') {
    currentAutoExpiryStockId = Number(stockId);
    const editor = document.getElementById('auto-expiry-editor');
    const label = document.getElementById('auto-expiry-stock-label');
    const currentExpiryInput = document.getElementById('auto-current-expiry');
    const expiryDateInput = document.getElementById('auto-expiry-date');
    const addDaysInput = document.getElementById('auto-add-days');
    const msg = document.getElementById('auto-expiry-msg');

    if (!editor || !label || !expiryDateInput || !msg) return;

    label.textContent = currentAutoExpiryStockId;
    
    // Set current expiry
    if (currentExpiry) {
      currentExpiryInput.value = currentExpiry.slice(0, 10);
      expiryDateInput.value = currentExpiry.slice(0, 10);
    } else {
      // Fetch current expiry from database
      fetchCurrentExpiry(currentAutoExpiryStockId);
    }
    
    // Reset add days
    addDaysInput.value = '0';
    
    msg.textContent = '';
    msg.style.color = '';
    editor.style.display = 'block';
    editor.scrollIntoView({ behavior: 'smooth' });
  }

  async function fetchCurrentExpiry(stockId) {
    try {
      const { data, error } = await supabaseClient
        .from('product_plan_stocks')
        .select('premium_until')
        .eq('id', stockId)
        .maybeSingle();

      if (!error && data && data.premium_until) {
        document.getElementById('auto-current-expiry').value = data.premium_until.slice(0, 10);
        document.getElementById('auto-expiry-date').value = data.premium_until.slice(0, 10);
      } else {
        // Default to today + 30 days
        const futureDate = new Date();
        futureDate.setDate(futureDate.getDate() + 30);
        const dateStr = futureDate.toISOString().split('T')[0];
        document.getElementById('auto-current-expiry').value = dateStr;
        document.getElementById('auto-expiry-date').value = dateStr;
      }
    } catch (error) {
      console.error('Error loading expiry date:', error);
    }
  }

  function calculateAutoExpiry() {
    const currentExpiry = document.getElementById('auto-current-expiry').value;
    const addDays = parseInt(document.getElementById('auto-add-days').value) || 0;
    const expiryDateInput = document.getElementById('auto-expiry-date');
    
    if (!currentExpiry) {
      showMessage('auto-expiry-msg', 'Please set current expiry first', 'error');
      return;
    }
    
    const newDate = new Date(currentExpiry);
    newDate.setDate(newDate.getDate() + addDays);
    
    expiryDateInput.value = newDate.toISOString().split('T')[0];
    showMessage('auto-expiry-msg', `Expiry calculated: +${addDays} days`, 'success');
  }

  async function saveAutoExpiry() {
    const msg = document.getElementById('auto-expiry-msg');
    const expiryDateInput = document.getElementById('auto-expiry-date');
    const addDaysInput = document.getElementById('auto-add-days');

    if (!currentAutoExpiryStockId) {
      msg.textContent = 'Missing stock ID';
      msg.style.color = 'var(--danger)';
      return;
    }

    const newExp = expiryDateInput.value;
    const addDays = parseInt(addDaysInput.value) || 0;
    
    if (!newExp) {
      msg.textContent = 'Please choose a date';
      msg.style.color = 'var(--danger)';
      return;
    }

    msg.textContent = 'Saving...';
    msg.style.color = '';

    try {
      // Update stock expiry
      const { error: stockError } = await supabaseClient
        .from('product_plan_stocks')
        .update({ premium_until: newExp })
        .eq('id', currentAutoExpiryStockId);

      if (stockError) throw stockError;

      msg.textContent = 'Expiry updated successfully';
      msg.style.color = 'var(--success)';

      // Reload data
      setTimeout(() => {
        loadSoldStocks();
        loadRecordsAll();
        loadRecordsAuto();
        loadDashboard();
        cancelAutoExpiry();
      }, 1500);
    } catch (error) {
      console.error('Error updating expiry:', error);
      msg.textContent = 'Error updating expiry';
      msg.style.color = 'var(--danger)';
    }
  }

  function cancelAutoExpiry() {
    currentAutoExpiryStockId = null;
    const editor = document.getElementById('auto-expiry-editor');
    const msg = document.getElementById('auto-expiry-msg');
    const currentExpiryInput = document.getElementById('auto-current-expiry');
    const expiryDateInput = document.getElementById('auto-expiry-date');
    const addDaysInput = document.getElementById('auto-add-days');
    
    if (editor) editor.style.display = 'none';
    if (msg) msg.textContent = '';
    if (currentExpiryInput) currentExpiryInput.value = '';
    if (expiryDateInput) expiryDateInput.value = '';
    if (addDaysInput) addDaysInput.value = '0';
  }

  
  // ---------- Helpers ----------
  function getPlanMeta(productId, planType) {
    if (!ownerPlans || !ownerPlans.length) return null;
    return ownerPlans.find(pl => Number(pl.product_id) === Number(productId) && String(pl.plan_type) === String(planType)) || null;
  }
// ---------- Records Functions ----------
  // UPDATE: fetchUnifiedRecords function para kunin ang totoong buyer info

async function fetchUnifiedRecords() {
  // Unified records = TG Bot sales (auto) + Manual sales
  // This function is resilient: it DOES NOT require a "stock_records" view to exist.
  const normalizeDate = (d) => {
    try { return d ? new Date(d).toISOString() : null; } catch { return null; }
  };

  // 1) Manual sales
  const manualRes = await supabase
    .from('manual_stock_records')
    .select('*')
    .order('created_at', { ascending: false });

  if (manualRes.error) throw manualRes.error;

  const manual = (manualRes.data || []).map(r => ({
    id: r.id,
    source: 'MANUAL',
    source_label: 'Manual',
    order_id: r.plan_id ?? null,
    buyer_name: r.buyer_name ?? 'Manual Buyer',
    buyer_telegram_id: r.buyer_telegram_id ?? null,
    buyer_username: r.buyer_username ?? null,
    product_id: r.product_id ?? null,
    plan_id: r.plan_id ?? null,
    plan_type: r.plan_type ?? null,
    duration: r.duration ?? null,
    price: Number(r.price ?? 0),
    sold_at: normalizeDate(r.date_availed ?? r.created_at),
    expiry_date: r.expiry_date ?? null,
    account_email: r.account_email ?? null,
    account_password: r.account_password ?? null,
    notes: r.notes ?? null,
    raw: r
  }));

  // 2) TG Bot sales from product_plan_stocks that are USED (is_used = true)
  const autoStocksRes = await supabase
    .from('product_plan_stocks')
    .select('id, product_id, plan_id, email, password, order_id, used_at, used_plan_type, used_duration, plan_type, plan_duration, is_used')
    .eq('is_used', true)
    .order('used_at', { ascending: false });

  if (autoStocksRes.error) throw autoStocksRes.error;

  const autoStocks = autoStocksRes.data || [];
  const orderIds = [...new Set(autoStocks.map(s => s.order_id).filter(Boolean))];

  // Pull orders + users in batches (simple and reliable)
  let ordersById = {};
  let usersById = {};

  if (orderIds.length) {
    const ordersRes = await supabase
      .from('orders')
      .select('id, user_id, telegram_id, price, created_at, status')
      .in('id', orderIds);

    if (ordersRes.error) throw ordersRes.error;

    const orders = ordersRes.data || [];
    ordersById = Object.fromEntries(orders.map(o => [o.id, o]));

    const userIds = [...new Set(orders.map(o => o.user_id).filter(Boolean))];
    if (userIds.length) {
      const usersRes = await supabase
        .from('users')
        .select('id, telegram_id, username, first_name')
        .in('id', userIds);

      if (usersRes.error) throw usersRes.error;
      const users = usersRes.data || [];
      usersById = Object.fromEntries(users.map(u => [u.id, u]));
    }
  }

  const auto = autoStocks.map(s => {
    const o = s.order_id ? ordersById[s.order_id] : null;
    const u = o?.user_id ? usersById[o.user_id] : null;

    const username = (u?.username || '').trim();
    const displayUsername = username ? `@${username.replace(/^@/, '')}` : null;

    const buyerTelegram = u?.telegram_id ?? o?.telegram_id ?? null;
    const buyerName = displayUsername || u?.first_name || (buyerTelegram ? `TG: ${buyerTelegram}` : 'TG Bot Buyer');

    return {
      id: s.id,
      source: 'AUTO',
      source_label: 'TG Bot',
      order_id: s.order_id ?? null,
      buyer_name: buyerName,
      buyer_telegram_id: buyerTelegram,
      buyer_username: displayUsername,
      product_id: s.product_id ?? null,
      plan_id: s.plan_id ?? null,
      plan_type: s.used_plan_type ?? s.plan_type ?? null,
      duration: s.used_duration ?? s.plan_duration ?? null,
      price: Number(o?.price ?? 0),
      sold_at: normalizeDate(s.used_at ?? o?.created_at),
      expiry_date: null,
      account_email: s.email ?? null,
      account_password: s.password ?? null,
      notes: null,
      raw: { stock: s, order: o, user: u }
    };
  });

  // Merge and sort
  const merged = [...auto, ...manual].sort((a, b) => {
    const ad = a.sold_at ? new Date(a.sold_at).getTime() : 0;
    const bd = b.sold_at ? new Date(b.sold_at).getTime() : 0;
    return bd - ad;
  });

  return merged;
}

function getStockIdFromRecord(r) {
    return pickFirst(r.stock_id, r.stockId, r.stock, r.account_id, r.accountId, r.stock_uuid, r.stock_uid, r.stockID, r.accountID);
  }

  
  }

  async function loadRecordsAuto() {
    const tbody = document.querySelector('#auto-records-table tbody');
    const summaryBox = document.getElementById('records-auto-summary');
    
    if (!tbody) return;
    
    tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 2rem;"><i class="fas fa-spinner fa-spin"></i> Loading TG bot sales...</td></tr>';
    if (summaryBox) summaryBox.textContent = 'Loading...';

    try {
      const { data, error } = await fetchUnifiedRecords();
      if (error) throw error;

      const autoRecords = (data || []).filter(r => r.source === 'AUTO');
      renderRecordsTable('auto-records-table', autoRecords);
    } catch (error) {
      console.error('Error loading auto records:', error);
      tbody.innerHTML = '<tr><td colspan="6" class="message message-error">Error loading records</td></tr>';
    }
  }

  async function loadRecordsManual() {
    const tbody = document.querySelector('#manual-records-table tbody');
    const summaryBox = document.getElementById('records-manual-summary');
    
    if (!tbody) return;
    
    tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 2rem;"><i class="fas fa-spinner fa-spin"></i> Loading manual sales...</td></tr>';
    if (summaryBox) summaryBox.textContent = 'Loading...';

    try {
      const { data, error } = await fetchUnifiedRecords();
      if (error) throw error;

      const manualRecords = (data || []).filter(r => r.source === 'MANUAL');
      renderRecordsTable('manual-records-table', manualRecords);
    } catch (error) {
      console.error('Error loading manual records:', error);
      tbody.innerHTML = '<tr><td colspan="6" class="message message-error">Error loading records</td></tr>';
    }
  }

  
  
  function renderRecordsTable(tableId, records) {
    const table = document.getElementById(tableId);
    if (!table) return;

    const tbody = table.querySelector('tbody');
    if (!tbody) return;

    // Build plan map once
    const planMap = {};
    (allPlans || []).forEach(p => { planMap[p.id] = p; });

    let total = 0;
    tbody.innerHTML = (records || []).map((r, idx) => {
      const price = Number(r.price || 0);
      total += price;

      const plan = r.plan_id ? (planMap[r.plan_id] || null) : null;
      const cost = plan ? Number(plan.price_reseller || 0) : 0;
      // Stock age = (sold date - stock created)
      let stockAgeText = '—';
      if (r.stock_created_at && (r.used_at || r.date_sold)) {
        const ageMs = new Date(r.used_at || r.date_sold).getTime() - new Date(r.stock_created_at).getTime();
        const days = Math.max(0, Math.floor(ageMs / (1000 * 60 * 60 * 24)));
        stockAgeText = `${days}d`;
      }

      const buyerUsername = r.buyer_telegram_username ? `@${r.buyer_telegram_username}` : null;
      const buyerLine = buyerUsername || (r.buyer_telegram_id ? `TG: @${r.buyer_telegram_id}` : 'N/A');

      // Safe JSON for onclick (single-quote attribute)
      const json = JSON.stringify(r).replace(/</g, '\\u003c').replace(/>/g, '\\u003e').replace(/'/g, "\\'");

      return `
        <tr>
          <td>${idx + 1}</td>
          <td>${escapeHtml(r.source || '')}</td>
          <td>
            <div style="font-weight:700">${escapeHtml(r.buyer_name || 'N/A')}</div>
            <div style="font-size:.85rem; color: var(--text-medium)">${escapeHtml(buyerLine)}</div>
          </td>
          <td>
            <div style="font-weight:800">${escapeHtml(r.product_name || '')}</div>
            <div style="font-size:.85rem; color: var(--text-medium)">${escapeHtml(r.plan_type || '')} ${r.duration ? `• ${escapeHtml(r.duration)}` : ''}</div>
          </td>
          <td>
            <div style="font-weight:700">${escapeHtml(r.account_email || 'N/A')}</div>
          </td>
          <td>${formatDate(r.used_at || r.date_sold)}</td>
          <td>${formatMoney(price)}</td>
                    <td>${escapeHtml(stockAgeText)}</td>
          <td>
            <button class="btn btn-sm btn-outline" onclick='showSoldDetails(${json})'>View</button>
          </td>
        </tr>
      `;
    }).join('');

    // Update summary boxes for records table
    if (tableId === 'records-table') {
      const summaryEl = document.getElementById('records-summary');
      if (summaryEl) summaryEl.textContent = `${records.length} records • Total: ${formatMoney(total)}`;

      const profitEl =       if (profitEl) profitEl.textContent = `Estimated  ${formatMoney(totalProfit)} • (Sale - Reseller Price)`;
    }
  }

      const buyerUsername = r.buyer_telegram_username ? `@${r.buyer_telegram_username}` : null;
      const buyerLine = buyerUsername || (r.buyer_telegram_id ? `TG: @${r.buyer_telegram_id}` : 'N/A');

      return `
        <tr>
          <td>${idx + 1}</td>
          <td>${escapeHtml(r.source || '')}</td>
          <td>
            <div style="font-weight:700">${escapeHtml(r.buyer_name || 'N/A')}</div>
            <div style="font-size:.85rem; color: var(--text-medium)">${escapeHtml(buyerLine)}</div>
          </td>
          <td>
            <div style="font-weight:800">${escapeHtml(r.product_name || '')}</div>
            <div style="font-size:.85rem; color: var(--text-medium)">${escapeHtml(r.plan_type || '')} ${r.duration ? `• ${escapeHtml(r.duration)}` : ''}</div>
          </td>
          <td>
            <div style="font-weight:700">${escapeHtml(r.account_email || 'N/A')}</div>
          </td>
          <td>${formatDate(r.used_at || r.date_sold)}</td>
          <td>${formatMoney(price)}</td>
                    <td>${escapeHtml(stockAgeText)}</td>
          <td>
            <button class="btn btn-sm btn-outline" onclick="openRecordDetails('${tableId}', ${idx})">View</button>
          </td>
        </tr>
      `;
    }).join('');

    // Update summary boxes for records table
    if (tableId === 'records-table') {
      const summaryEl = document.getElementById('records-summary');
      if (summaryEl) {
        summaryEl.textContent = `${records.length} records • Total: ${formatMoney(total)}`;
      }
      const profitEl =       if (profitEl) {
        profitEl.textContent = `Estimated  ${formatMoney(totalProfit)} • (Sale - Reseller Price)`;
      }
    }
  }
    
    if (!tbody) return;
    
    if (!records || records.length === 0) {
      tbody.innerHTML = '<tr><td colspan="' + (tableId === 'records-table' ? 7 : 6) + '" class="message message-info">No records found</td></tr>';
      if (summaryBox) summaryBox.textContent = 'No records found';
      return;
    }

    // Apply filters
    let filteredRecords = records;
    
    // Apply period filter
    const periodSelect = tableId === 'records-table' ? 
      document.getElementById('records-period') : 
      tableId === 'auto-records-table' ?
      document.getElementById('auto-records-period') :
      document.getElementById('manual-records-period');
    
    const period = periodSelect ? periodSelect.value : 'today';
    
    if (period === 'custom') {
      const specificDate = document.getElementById('records-specific-date')?.value;
      if (specificDate) {
        const startDate = new Date(specificDate);
        const endDate = new Date(startDate);
        endDate.setDate(endDate.getDate() + 1);
        
        filteredRecords = filteredRecords.filter(r => {
          const recordDate = r.date_availed || r.used_at || r.created_at;
          if (!recordDate) return false;
          const date = new Date(recordDate);
          return date >= startDate && date < endDate;
        });
      }
    } else if (period !== 'all') {
      filteredRecords = applyDateFilter(filteredRecords, period);
    }
    
    // Apply platform filter for all records
    if (tableId === 'records-table') {
      const platformFilter = document.getElementById('records-platform')?.value || 'all';
      if (platformFilter !== 'all') {
        filteredRecords = filteredRecords.filter(r => 
          r.platform === platformFilter || (r.source === 'AUTO' && platformFilter === 'TG')
        );
      }
    }
    
    // FIXED: Apply product filter
    const productFilterId = tableId === 'records-table' ? 'records-product' :
                           tableId === 'auto-records-table' ? 'auto-records-product' :
                           'manual-records-product';
    
    const productFilter = document.getElementById(productFilterId)?.value || 'all';
    if (productFilter !== 'all') {
      filteredRecords = filteredRecords.filter(r => {
        return r.product_id == productFilter;
      });
    }

    if (!filteredRecords.length) {
      tbody.innerHTML = '<tr><td colspan="' + (tableId === 'records-table' ? 7 : 6) + '" class="message message-info">No records for selected filters</td></tr>';
      if (summaryBox) summaryBox.textContent = 'No records for selected filters';
      return;
    }

    // Calculate summary
    let autoCount = 0;
    let manualCount = 0;
    let autoRevenue = 0;
    let manualRevenue = 0;
    
    filteredRecords.forEach(r => {
      const price = r.price != null ? Number(r.price) : 0;
      if (r.source === 'AUTO') {
        autoCount++;
        autoRevenue += price;
      } else {
        manualCount++;
        manualRevenue += price;
      }
    });
    
    if (summaryBox) {
      const totalRevenue = autoRevenue + manualRevenue;
      summaryBox.textContent = `${filteredRecords.length} records • Auto: ${autoCount} (₱${autoRevenue.toFixed(2)}) • Manual: ${manualCount} (₱${manualRevenue.toFixed(2)}) • Total: ₱${totalRevenue.toFixed(2)}`;
    }

    // Render table
    let html = '';
    filteredRecords.forEach((record, index) => {
      const sourceBadge = record.source === 'AUTO' ? 
        '<span class="badge badge-auto">AUTO</span>' : 
        '<span class="badge badge-manual">MANUAL</span>';
      
      const price = record.price ? `₱${Number(record.price).toFixed(2)}` : '-';
      
      let actionsHtml = '';
      if (record.source === 'MANUAL') {
        actionsHtml = `
          <div style="display: flex; gap: 0.3rem;">
            <button class="btn btn-sm btn-primary" onclick="showSoldDetails(${JSON.stringify(record).replace(/\"/g,'&quot;')})" style="padding: 0.3rem 0.6rem;">
              <i class=\"fas fa-eye\"></i>
            </button>
            <button class="btn btn-sm btn-secondary" onclick="window.editManualRecord(${record.record_id || record.id})" style="padding: 0.3rem 0.6rem;">
              <i class="fas fa-edit"></i>
            </button>
            <button class="btn btn-sm btn-secondary" onclick="window.deleteManualRecord(${record.record_id || record.id})" style="padding: 0.3rem 0.6rem; background: var(--danger);">
              <i class="fas fa-trash"></i>
            </button>
          </div>
        `;
      } else {
        const stockId = getStockIdFromRecord(record);
        if (stockId) {
          actionsHtml = `
            <div style="display:flex; gap:0.3rem;">
              <button class="btn btn-sm btn-primary" onclick="showSoldDetails(${JSON.stringify(record).replace(/\"/g,'&quot;')})" style="padding: 0.3rem 0.6rem;">
                <i class=\"fas fa-eye\"></i>
              </button>
              <button class="btn btn-sm btn-secondary" onclick="window.startAutoExpiryEdit(${stockId}, '${record.new_expiry || ''}')" style="padding: 0.3rem 0.6rem;">
                <i class="fas fa-calendar-alt"></i>
              </button>
            </div>
          `;
        }
      }

      if (tableId === 'records-table') {
        html += `
          <tr>
            <td><strong>#${index + 1}</strong></td>
            <td>${sourceBadge}</td>
            <td>
              <div><strong>${record.buyer_name || '-'}</strong></div>
              <div><small>TG: ${record.buyer_telegram_id || '-'}</small></div>
            </td>
            <td>
              <div><strong>${record.product_name || '-'}</strong></div>
              <div><small>${record.plan_type || '-'}</small></div>
            </td>
            <td>
              <div><small>${record.account_email || '-'}</small></div>
            </td>
            <td><strong>${price}</strong></td>
            <td class="actions-cell">${actionsHtml}</td>
          </tr>
        `;
      } else {
        html += `
          <tr>
            <td><strong>#${index + 1}</strong></td>
            <td>
              <div><strong>${record.buyer_name || '-'}</strong></div>
              <div><small>TG: ${record.buyer_telegram_id || '-'}</small></div>
            </td>
            <td>
              <div><strong>${record.product_name || '-'}</strong></div>
              <div><small>${record.plan_type || '-'}</small></div>
            </td>
            <td>
              <div><small>${record.account_email || '-'}</small></div>
            </td>
            <td><strong>${price}</strong></td>
            <td class="actions-cell">${actionsHtml}</td>
          </tr>
        `;
      }
    });

    tbody.innerHTML = html;
  }

  function applyDateFilter(records, period) {
    const now = new Date();
    let startDate, endDate;
    
    switch (period) {
      case 'today':
        startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());
        endDate = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1);
        break;
      case 'yesterday':
        startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate() - 1);
        endDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());
        break;
      case 'week':
        const dayOfWeek = now.getDay();
        const diff = now.getDate() - dayOfWeek + (dayOfWeek === 0 ? -6 : 1);
        startDate = new Date(now.getFullYear(), now.getMonth(), diff);
        endDate = new Date(now.getFullYear(), now.getMonth(), diff + 7);
        break;
      case 'month':
        startDate = new Date(now.getFullYear(), now.getMonth(), 1);
        endDate = new Date(now.getFullYear(), now.getMonth() + 1, 1);
        break;
      default:
        return records;
    }
    
    return records.filter(record => {
      const recordDate = record.date_availed || record.used_at || record.created_at;
      if (!recordDate) return false;
      
      const date = new Date(recordDate);
      return date >= startDate && date < endDate;
    });
  }

  // ---------- Manual Record Functions ----------
  
  function populateManualDropdowns(forceProductId, forcePlanType, forceDuration) {
    const prodSel = document.getElementById('manual-product');
    const typeSel = document.getElementById('manual-plan-type');
    const durSel = document.getElementById('manual-duration');

    if (!prodSel || !typeSel || !durSel) return;
    if (!ownerProducts.length || !ownerPlans.length) return;

    // Clear existing options
    prodSel.innerHTML = '<option value="">Select Product</option>';
    typeSel.innerHTML = '<option value="">Select Plan Type</option>';
    durSel.innerHTML = '<option value="">Select Duration</option>';

    // kung wala pang value, gagamit tayo ng default
    let productId = forceProductId ?? (prodSel.value ? Number(prodSel.value) : null);
    if (!productId) productId = ownerProducts[0].id;

    // options para sa product
    ownerProducts.forEach(p => {
      const opt = document.createElement('option');
      opt.value = String(p.id);
      opt.textContent = p.name;
      if (p.id === productId) opt.selected = true;
      prodSel.appendChild(opt);
    });

    const plansForProduct = ownerPlans.filter(pl => pl.product_id === productId);
    const types = [...new Set(plansForProduct.map(pl => pl.plan_type))];

    // Plan type options
    let selectedType = forcePlanType ?? (types.includes(typeSel.value) ? typeSel.value : null);
    if (!selectedType && types.length) selectedType = types[0];

    types.forEach(t => {
      const opt = document.createElement('option');
      opt.value = t;
      opt.textContent = t;
      if (t === selectedType) opt.selected = true;
      typeSel.appendChild(opt);
    });

    // Duration options – depende sa plan type
    const plansForType = plansForProduct.filter(pl => pl.plan_type === selectedType);

    let selectedDur = forceDuration ?? (plansForType[0]?.duration ?? null);

    // FOR ALL PLAN TYPES: Add "Any Duration" option
    const anyDurationExists = plansForType.some(pl => 
      pl.duration.toLowerCase().includes('any')
    );

    if (!anyDurationExists) {
      // Add "Any Duration" as the first option for ALL plan types
      const opt = document.createElement('option');
      opt.value = 'Any Duration';
      opt.textContent = 'Any Duration';
      if (!selectedDur) selectedDur = 'Any Duration';
      durSel.appendChild(opt);
    }

    plansForType.forEach(pl => {
      const price = pl.price_regular != null ? pl.price_regular : (pl.price || 0);
      const opt = document.createElement('option');
      opt.value = pl.duration;
      opt.textContent = `${pl.duration} — ₱${Number(price).toFixed(2)}`;
      if (pl.duration === selectedDur) opt.selected = true;
      durSel.appendChild(opt);
    });

    // Setup change events
    prodSel.onchange = () => {
      const newId = Number(prodSel.value);
      populateManualDropdowns(newId, null, null);
      initManualExpiryCalculator(); // Recalculate expiry
    };

    typeSel.onchange = () => {
      populateManualDropdowns(
        Number(prodSel.value || productId),
        typeSel.value,
        null
      );
      initManualExpiryCalculator(); // Recalculate expiry
    };

    durSel.onchange = () => {
      initManualExpiryCalculator(); // Recalculate expiry
    };
  }

  // ---------- AUTO-COMPUTE EXPIRY FUNCTIONS FROM ORIGINAL CODE ----------
  function parseDurationToMonths(durationText) {
    if (!durationText) return { months: 0, days: 0 };
    
    // SPECIAL CASE: For "Any Duration" - default to 1 month
    if (durationText === 'Any Duration') {
      // Default to 1 month for Any Duration
      return { months: 1, days: 0 };
    }

    const clean = durationText.split('—')[0].trim();
    const parts = clean.split(/\s+/);
    const n = parseInt(parts[0], 10);
    const unit = (parts[1] || '').toLowerCase();

    if (Number.isNaN(n)) return { months: 0, days: 0 };

    if (unit.startsWith('month')) {
      return { months: n, days: 0 };
    } else if (unit.startsWith('year')) {
      return { months: n * 12, days: 0 };
    } else if (unit.startsWith('day')) {
      return { months: 0, days: n };
    } else if (unit.startsWith('week')) {
      return { months: 0, days: n * 7 };
    }
    return { months: n, days: 0 };
  }

  function initManualExpiryCalculator() {
    const dateAvailedInput = document.getElementById('manual-date-availed');
    const durationSelect = document.getElementById('manual-duration');
    const additionalInput = document.getElementById('manual-add-days');
    const oldExpiryInput = document.getElementById('manual-old-expiry');
    const newExpiryInput = document.getElementById('manual-new-expiry');

    function recompute() {
      const dateStr = dateAvailedInput.value;
      const duration = durationSelect.value;
      const addDays = parseInt(additionalInput.value || '0', 10);

      if (!dateStr || !duration) {
        if (oldExpiryInput) oldExpiryInput.value = '';
        if (newExpiryInput) newExpiryInput.value = '';
        return;
      }

      const base = new Date(dateStr + 'T00:00:00');
      const { months, days } = parseDurationToMonths(duration);

      const oldExp = new Date(base);
      if (months) oldExp.setMonth(oldExp.getMonth() + months);
      if (days) oldExp.setDate(oldExp.getDate() + days);

      const newExp = new Date(oldExp);
      if (!Number.isNaN(addDays) && addDays > 0) {
        newExp.setDate(newExp.getDate() + addDays);
      }

      const fmt = (d) => d.toISOString().slice(0, 10);
      if (oldExpiryInput) oldExpiryInput.value = fmt(oldExp);
      if (newExpiryInput) newExpiryInput.value = fmt(newExp);
    }

    if (dateAvailedInput) dateAvailedInput.addEventListener('change', recompute);
    if (durationSelect) durationSelect.addEventListener('change', recompute);
    if (additionalInput) additionalInput.addEventListener('input', recompute);
    
    // Initial calculation
    if (dateAvailedInput && !dateAvailedInput.value) {
      dateAvailedInput.value = new Date().toISOString().split('T')[0];
    }
    recompute();
  }

  // FIXED: Manual record submission - using correct column names
  async function handleManualRecordSubmit(e) {
    e.preventDefault();
    showMessage('msg-record', 'Saving manual record...', 'info');

    const manualId = document.getElementById('manual-id').value || null;
    const buyerName = document.getElementById('manual-buyer-name').value.trim();
    const buyerTg = document.getElementById('manual-buyer-tg').value.trim() || null;
    const platform = document.getElementById('manual-platform').value || 'TG';
    const productId = Number(document.getElementById('manual-product').value);
    const planType = document.getElementById('manual-plan-type').value;
    const duration = document.getElementById('manual-duration').value;
    const priceRaw = document.getElementById('manual-price').value;
    const email = document.getElementById('manual-email').value.trim();
    const password = document.getElementById('manual-password').value.trim();
    const profile = document.getElementById('manual-profile').value.trim() || null;
    const pin = document.getElementById('manual-pin').value.trim() || null;
    const dateAvail = document.getElementById('manual-date-availed').value || null;
    const oldExpiry = document.getElementById('manual-old-expiry').value || null;
    const newExpiry = document.getElementById('manual-new-expiry').value || null;
    const addDaysRaw = document.getElementById('manual-add-days').value;
    const notes = document.getElementById('manual-notes').value.trim() || null;

    // Validate required fields
    if (!productId || !planType || !duration || !priceRaw || !email || !dateAvail) {
      showMessage('msg-record', 'Please fill in all required fields', 'error');
      return;
    }

    const additionalDays = addDaysRaw === '' ? 0 : Number(addDaysRaw);
    const price = priceRaw === '' ? null : Number(priceRaw);

    if (price === null || Number.isNaN(price)) {
      showMessage('msg-record', 'Please enter a valid price', 'error');
      return;
    }

    try {
      let planId = null; // Default to NULL for "Any Duration"

      if (duration === 'Any Duration') {
        // For "Any Duration", we don't assign a specific plan_id
        planId = null;
      } else {
        // For specific durations, find the matching plan
        const planRow = findPlan(productId, planType, duration);
        if (!planRow) {
          showMessage('msg-record', 'No matching plan found for selected product, type, and duration', 'error');
          return;
        }
        planId = planRow.id;
      }

      // FIXED: Use correct column names based on your original code
      const payload = {
        product_id: productId,
        plan_id: planId,
        product_name: ownerProducts.find(p => p.id === productId)?.name || '',
        plan_type: planType,
        duration: duration,
        price: price,
        account_email: email,
        account_password: password || null,
        account_profile: profile,
        account_pin: pin,
        date_availed: dateAvail,
        old_expiry: oldExpiry,
        new_expiry: newExpiry,
        additional_days: additionalDays,
        buyer_name: buyerName || null,
        buyer_telegram_id: buyerTg,
        platform: platform,
        notes: notes
      };

      console.log('Saving manual record with payload:', payload);

      let error;
      if (manualId) {
        const res = await supabaseClient
          .from('manual_stock_records')
          .update(payload)
          .eq('id', Number(manualId));
        error = res.error;
      } else {
        const res = await supabaseClient
          .from('manual_stock_records')
          .insert(payload);
        error = res.error;
      }

      if (error) {
        console.error('Supabase error details:', error);
        throw error;
      }

      showMessage('msg-record', 'Manual record saved successfully', 'success');
      
      // Reset form
      document.getElementById('manualRecordForm').reset();
      document.getElementById('manual-id').value = '';
      document.getElementById('manual-platform').value = 'TG';
      document.getElementById('manual-date-availed').value = new Date().toISOString().split('T')[0];
      document.getElementById('manual-add-days').value = '0';
      
      // Re-populate dropdowns
      populateManualDropdowns();
      
      // Initialize expiry calculator
      initManualExpiryCalculator();
      
      // Reload records
      loadRecordsAll();
      loadRecordsManual();
      loadDashboard();
    } catch (error) {
      console.error('Error saving manual record:', error);
      showMessage('msg-record', `Error saving manual record: ${error.message}. Check console for details.`, 'error');
    }
  }

  async function editManualRecord(id) {
    try {
      const { data, error } = await supabaseClient
        .from('manual_stock_records')
        .select('*')
        .eq('id', id)
        .maybeSingle();

      if (error) throw error;
      if (!data) {
        showMessage('msg-record', 'Record not found', 'error');
        return;
      }

      // Populate dropdowns
      populateManualDropdowns(data.product_id, data.plan_type, data.duration);
      
      // Wait for dropdowns to populate
      setTimeout(() => {
        document.getElementById('manual-id').value = data.id;
        document.getElementById('manual-buyer-name').value = data.buyer_name || '';
        document.getElementById('manual-buyer-tg').value = data.buyer_telegram_id || '';
        document.getElementById('manual-platform').value = data.platform || 'TG';
        document.getElementById('manual-product').value = String(data.product_id);
        document.getElementById('manual-plan-type').value = data.plan_type;
        document.getElementById('manual-duration').value = data.duration;
        document.getElementById('manual-price').value = data.price || '';
        document.getElementById('manual-email').value = data.account_email || '';
        document.getElementById('manual-password').value = data.account_password || '';
        document.getElementById('manual-profile').value = data.account_profile || '';
        document.getElementById('manual-pin').value = data.account_pin || '';
        document.getElementById('manual-date-availed').value = data.date_availed || '';
        document.getElementById('manual-old-expiry').value = data.old_expiry || '';
        document.getElementById('manual-new-expiry').value = data.new_expiry || '';
        document.getElementById('manual-add-days').value = data.additional_days || 0;
        document.getElementById('manual-notes').value = data.notes || '';

        // Initialize expiry calculator
        initManualExpiryCalculator();

        // Switch to add record panel
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.content-panel').forEach(p => p.classList.remove('active'));
        document.querySelector('[data-panel="add-record"]').classList.add('active');
        document.getElementById('add-record-panel').classList.add('active');
      }, 100);
    } catch (error) {
      console.error('Error loading manual record for edit:', error);
      showMessage('msg-record', 'Error loading record for edit', 'error');
    }
  }

  async function deleteManualRecord(id) {
    if (!confirm('Are you sure you want to delete this manual record?')) return;

    try {
      const { error } = await supabaseClient
        .from('manual_stock_records')
        .delete()
        .eq('id', id);

      if (error) throw error;

      showMessage('msg-record', 'Manual record deleted successfully', 'success');
      
      // Reload records
      loadRecordsAll();
      loadRecordsManual();
      loadDashboard();
    } catch (error) {
      console.error('Error deleting manual record:', error);
      showMessage('msg-record', 'Error deleting manual record', 'error');
    }
  }

  // ---------- Rules Functions ----------
  async function handleAddRule(e) {
    e.preventDefault();
    showMessage('msg-rules', 'Saving rule...', 'info');

    const idInput = document.getElementById('rules-id');
    const productId = Number(document.getElementById('rules-product').value);
    const text = document.getElementById('rules-text').value.trim();
    const existingId = idInput.value ? Number(idInput.value) : null;

    if (!text) {
      showMessage('msg-rules', 'Please enter a rule', 'error');
      return;
    }

    if (!productId) {
      showMessage('msg-rules', 'Please select a product', 'error');
      return;
    }

    try {
      let error;
      if (existingId) {
        const res = await supabaseClient
          .from('product_rules')
          .update({ product_id: productId, rule_text: text })
          .eq('id', existingId);
        error = res.error;
      } else {
        const res = await supabaseClient
          .from('product_rules')
          .insert({
            product_id: productId,
            rule_text: text
          });
        error = res.error;
      }

      if (error) throw error;

      showMessage('msg-rules', existingId ? 'Rule updated successfully' : 'Rule added successfully', 'success');

      // Reset form
      idInput.value = '';
      document.getElementById('rules-text').value = '';

      // Reload rules list
      loadRulesList();
    } catch (error) {
      console.error('Error saving rule:', error);
      showMessage('msg-rules', 'Error saving rule', 'error');
    }
  }

  async function loadRulesList() {
    const prodSel = document.getElementById('rules-product');
    const rulesList = document.getElementById('rules-list');
    
    if (!prodSel || !rulesList) return;

    // Populate product dropdown if empty
    if (!prodSel.options.length) {
      prodSel.innerHTML = '<option value="">Select Product</option>';
      ownerProducts.forEach(p => {
        const opt = document.createElement('option');
        opt.value = String(p.id);
        opt.textContent = p.name;
        prodSel.appendChild(opt);
      });
    }

    const productId = Number(prodSel.value || (ownerProducts[0]?.id || ''));
    if (!productId) {
      rulesList.innerHTML = '<div class="message message-info">Please select a product</div>';
      return;
    }

    rulesList.innerHTML = '<div style="text-align: center; padding: 1rem;"><i class="fas fa-spinner fa-spin"></i> Loading rules...</div>';

    try {
      const { data, error } = await supabaseClient
        .from('product_rules')
        .select('id, rule_text, active')
        .eq('product_id', productId)
        .order('id', { ascending: true });

      if (error) throw error;

      if (!data || data.length === 0) {
        rulesList.innerHTML = '<div class="message message-info">No rules for this product yet</div>';
        return;
      }

      let html = '<div style="display: flex; flex-direction: column; gap: 1rem;">';
      data.forEach(r => {
        const status = r.active ? '' : '<span class="badge" style="background: var(--pastel-peach); color: var(--text-dark); margin-left: 0.5rem;">Inactive</span>';
        html += `
          <div style="padding: 1rem; background: white; border-radius: 12px; border: 1px solid var(--pastel-pink);">
            <div style="margin-bottom: 0.5rem;">${r.rule_text} ${status}</div>
            <div class="netflix-account-actions" style="display: flex; gap: 0.5rem;" onclick="event.stopPropagation();">
              <button class="btn btn-sm btn-secondary" onclick="window.editRule(${r.id})" style="padding: 0.3rem 0.6rem;">
                <i class="fas fa-edit"></i> Edit
              </button>
              <button class="btn btn-sm btn-secondary" onclick="window.deleteRule(${r.id})" style="padding: 0.3rem 0.6rem; background: var(--danger);">
                <i class="fas fa-trash"></i> Delete
              </button>
            </div>
          </div>
        `;
      });
      html += '</div>';

      rulesList.innerHTML = html;
    } catch (error) {
      console.error('Error loading rules:', error);
      rulesList.innerHTML = '<div class="message message-error">Error loading rules</div>';
    }
  }

  async function editRule(id) {
    try {
      const { data, error } = await supabaseClient
        .from('product_rules')
        .select('*')
        .eq('id', id)
        .maybeSingle();

      if (error) throw error;
      if (!data) {
        showMessage('msg-rules', 'Rule not found', 'error');
        return;
      }

      // Populate form
      document.getElementById('rules-id').value = data.id;
      document.getElementById('rules-product').value = String(data.product_id);
      document.getElementById('rules-text').value = data.rule_text;

      // Reload rules list for the selected product
      loadRulesList();

      // Scroll to form
      document.getElementById('rules-text').focus();
    } catch (error) {
      console.error('Error loading rule for edit:', error);
      showMessage('msg-rules', 'Error loading rule for edit', 'error');
    }
  }

  async function deleteRule(id) {
    if (!confirm('Are you sure you want to delete this rule?')) return;

    try {
      const { error } = await supabaseClient
        .from('product_rules')
        .delete()
        .eq('id', id);

      if (error) throw error;

      showMessage('msg-rules', 'Rule deleted successfully', 'success');
      loadRulesList();
    } catch (error) {
      console.error('Error deleting rule:', error);
      showMessage('msg-rules', 'Error deleting rule', 'error');
    }
  }

  // ---------- CSV Export ----------
  function downloadRecordsCsv() {
    let filtered = lastRecords || [];
    
    // Apply current filters
    const period = document.getElementById('records-period')?.value || 'today';
    if (period === 'custom') {
      const specificDate = document.getElementById('records-specific-date')?.value;
      if (specificDate) {
        const startDate = new Date(specificDate);
        const endDate = new Date(startDate);
        endDate.setDate(endDate.getDate() + 1);
        
        filtered = filtered.filter(r => {
          const recordDate = r.date_availed || r.used_at || r.created_at;
          if (!recordDate) return false;
          const date = new Date(recordDate);
          return date >= startDate && date < endDate;
        });
      }
    } else if (period !== 'all') {
      filtered = applyDateFilter(filtered, period);
    }
    
    const platformFilter = document.getElementById('records-platform')?.value || 'all';
    if (platformFilter !== 'all') {
      filtered = filtered.filter(r => 
        r.platform === platformFilter || (r.source === 'AUTO' && platformFilter === 'TG')
      );
    }
    
    const productFilter = document.getElementById('records-product')?.value || 'all';
    if (productFilter !== 'all') {
      filtered = filtered.filter(r => {
        return r.product_id == productFilter;
      });
    }

    if (!filtered || !filtered.length) {
      alert('No records for current filters.');
      return;
    }

    const headers = [
      'source',
      'record_id',
      'product_name',
      'plan_type',
      'duration',
      'account_email',
      'price',
      'buyer_name',
      'buyer_telegram_id',
      'platform',
      'date_availed'
    ];

    const rows = filtered.map(r =>
      headers.map(h => r[h] == null ? '' : r[h])
    );

    const csvLines = [
      headers.join(','),
      ...rows.map(row =>
        row.map(v => `"${String(v).replace(/"/g, '""')}"`).join(',')
      )
    ];

    const blob = new Blob([csvLines.join('\n')], {
      type: 'text/csv;charset=utf-8;'
    });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `aiaxstock-records-${new Date().toISOString().split('T')[0]}.csv`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }
// ---------- Netflix Management Functions ----------

// Global variables for Netflix management
let netflixAccounts = [];
let netflixProfiles = [];

// Load Netflix accounts and profiles
async function loadNetflixAccounts() {
  const accountsList = document.getElementById('netflix-accounts-list');
  if (!accountsList) return;
  
  accountsList.innerHTML = '<div style="text-align: center; padding: 2rem;"><i class="fas fa-spinner fa-spin"></i> Loading Netflix accounts...</div>';

  try {
    // Load Netflix accounts
    const { data: accounts, error: accountsError } = await supabaseClient
      .from('netflix_accounts')
      .select('*')
      .order('created_at', { ascending: false });

    if (accountsError) throw accountsError;
    netflixAccounts = accounts || [];

    // Load profiles for each account
    const { data: profiles, error: profilesError } = await supabaseClient
      .from('netflix_profiles')
      .select('*, netflix_profile_users(*)')
      .order('profile_number', { ascending: true });

    if (profilesError) throw profilesError;
    netflixProfiles = profiles || [];

    // Calculate summary statistics
    updateNetflixSummary();

    // Render accounts
    renderNetflixAccounts();
  } catch (error) {
    console.error('Error loading Netflix accounts:', error);
    accountsList.innerHTML = '<div class="message message-error">Error loading Netflix accounts</div>';
  }
}

// Update Netflix summary cards
function updateNetflixSummary() {
  const accountCount = document.getElementById('netflix-account-count');
  const userCount = document.getElementById('netflix-user-count');
  const slotCount = document.getElementById('netflix-slot-count');
  const expiryCount = document.getElementById('netflix-expiry-count');

  if (!accountCount) return;

  // Total accounts
  const activeAccounts = netflixAccounts.filter(acc => acc.is_active).length;
  accountCount.textContent = activeAccounts;

  // Total users across all profiles
  let totalUsers = 0;
  netflixProfiles.forEach(profile => {
    totalUsers += (profile.netflix_profile_users || []).length;
  });
  userCount.textContent = totalUsers;

  // Used slots vs total slots
  const totalSlots = netflixProfiles.length;
  const usedSlots = netflixProfiles.filter(p => 
    p.netflix_profile_users && p.netflix_profile_users.length > 0
  ).length;
  slotCount.textContent = `${usedSlots}/${totalSlots}`;

  // Expiring soon (within 7 days)
  const today = new Date();
  const nextWeek = new Date(today);
  nextWeek.setDate(nextWeek.getDate() + 7);
  
  let expiringSoon = 0;
  netflixProfiles.forEach(profile => {
    if (profile.netflix_profile_users) {
      profile.netflix_profile_users.forEach(user => {
        if (user.expiry_date) {
          const expiry = new Date(user.expiry_date);
          if (expiry >= today && expiry <= nextWeek) {
            expiringSoon++;
          }
        }
      });
    }
  });
  expiryCount.textContent = expiringSoon;
}

// Render Netflix accounts
function renderNetflixAccounts() {
  
  const accountsList = document.getElementById('netflix-accounts-list');
  if (!accountsList) return;

  if (netflixAccounts.length === 0) {
    accountsList.innerHTML = `
      <div class="message message-info" style="text-align: center;">
        <i class="fas fa-film"></i> No Netflix accounts found. 
        <button class="btn btn-sm btn-primary" onclick="showAddNetflixAccount()" 
          style="margin-left: 0.5rem;">
          Add your first account
        </button>
      </div>
    `;
    return;
  }

  let html = '<div class="netflix-accounts-container">';
  
  netflixAccounts.forEach(account => {
    // Get profiles for this account
    const accountProfiles = netflixProfiles.filter(p => p.netflix_account_id === account.id);
    
    // Calculate account statistics
    const totalProfiles = accountProfiles.length;
    const usedProfiles = accountProfiles.filter(p => 
      p.netflix_profile_users && p.netflix_profile_users.length > 0
    ).length;
    
    const statusColor = !account.is_active ? 'var(--danger)' : 
                       usedProfiles >= totalProfiles ? 'var(--warning)' : 
                       'var(--success)';
    const statusText = !account.is_active ? 'Inactive' : 
                      usedProfiles >= totalProfiles ? 'Full' : 
                      'Active';
    
    html += `
      <div class="netflix-account-card collapsed" id="netflix-card-${account.id}"
     style="background: white; border-radius: var(--border-radius); padding: 1.5rem; margin-bottom: 1.5rem; border: 2px solid ${statusColor}; box-shadow: var(--shadow);">

        
        <div class="netflix-account-header" 
     onclick="toggleNetflixAccount(${account.id})" 
     style="display:flex; justify-content:space-between; cursor:pointer;">

          <div>
            <h4 style="margin: 0; color: var(--text-dark);">
              <i class="fas fa-envelope"></i> ${account.email}
            </h4>
            <div class="netflix-account-info" 
     style="display: flex; gap: 1rem; margin-top: 0.5rem; font-size: 0.9rem;">
<span><strong>Password:</strong> ${account.password}</span>
              <span class="badge" style="background: ${statusColor}; color: white;">
                ${statusText}
              </span>
              <span>Profiles: ${usedProfiles}/${totalProfiles}</span>
            </div>
          </div>
          
          <div class="netflix-account-actions" style="display: flex; gap: 0.5rem;" onclick="event.stopPropagation();">
            <button class="btn btn-sm btn-secondary" onclick="event.stopPropagation(); showAddUserToAccount(${account.id})"
              ${!account.is_active ? 'disabled' : ''}>
              <i class="fas fa-user-plus"></i> Add User
            </button>
            <button class="btn btn-sm btn-secondary" onclick="event.stopPropagation(); editNetflixAccount(${account.id})">
              <i class="fas fa-edit"></i>
            </button>
            <button class="btn btn-sm btn-secondary" onclick="event.stopPropagation(); deleteNetflixAccount(${account.id})" 
              style="background: var(--danger);">
              <i class="fas fa-trash"></i>
            </button>
          </div>
        </div>
        
        ${account.notes ? `
          <div class="netflix-notes-section" 
     style="margin-bottom: 1rem; padding: 0.75rem; background: var(--pastel-gray); 
     border-radius: 8px; font-size: 0.9rem;">
  <strong>Notes:</strong> ${account.notes}
</div>

        ` : ''}
        
        <!-- Profiles Section -->
        <div class="netflix-profiles-section">
          <h5 style="margin-top: 0; margin-bottom: 1rem; color: var(--text-medium);">
            <i class="fas fa-users"></i> Profiles (${totalProfiles}/5)
          </h5>
          
          <div class="profiles-grid" style="
            display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); 
            gap: 1rem;">
    `;
    
    // Show existing profiles
    accountProfiles.forEach(profile => {
      const users = profile.netflix_profile_users || [];
      const profileAlias = profile.alias || `Profile ${profile.profile_number}`;
      
      html += `
        <div class="profile-card" style="
          background: ${users.length > 0 ? 'var(--pastel-pink)' : 'var(--pastel-gray)'}; 
          border-radius: 12px; padding: 1rem; border: 1px solid var(--pastel-pink);">
          
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
            <div>
              <strong>${profileAlias}</strong>
              <div style="font-size: 0.8rem; color: var(--text-medium);">
                ${profile.profile_name ? `(${profile.profile_name})` : ''}
              </div>
            </div>
            <span class="badge badge-quantity">${users.length}</span>
          </div>
          
          <!-- Users in this profile -->
          <div class="profile-users" style="margin-top: 0.5rem;">
      `;
      
      if (users.length > 0) {
        users.forEach(user => {
          const expiryDate = user.expiry_date ? 
            new Date(user.expiry_date).toLocaleDateString('en-PH') : 'No expiry';
          
          html += `
            <div class="profile-user" style="
              background: white; border-radius: 8px; padding: 0.75rem; margin-bottom: 0.5rem;
              border-left: 3px solid var(--pastel-blue);">
              <div style="display: flex; justify-content: space-between;">
                <div>
                  <strong>${user.buyer_name}</strong>
                  <div style="font-size: 0.8rem; color: var(--text-medium);">
                    ${user.buyer_telegram_id ? `TG: ${user.buyer_telegram_id}` : ''}
                  </div>
                </div>
                <button class="btn btn-sm btn-secondary" onclick="removeProfileUser(${user.id})" 
                  style="padding: 0.2rem 0.5rem; background: var(--danger);">
                  <i class="fas fa-times"></i>
                </button>
              </div>
              <div style="font-size: 0.75rem; margin-top: 0.25rem;">
                <div>Availed: ${new Date(user.date_availed).toLocaleDateString('en-PH')}</div>
                <div>Expires: ${expiryDate}</div>
              </div>
            </div>
          `;
        });
      } else {
        html += `
          <div style="text-align: center; padding: 1rem; color: var(--text-light);">
            <i class="fas fa-user-slash"></i> No users in this profile
            <button class="btn btn-sm btn-secondary" 
              onclick="showAddUserToProfile(${profile.id}, ${account.id})"
              style="margin-top: 0.5rem;">
              <i class="fas fa-user-plus"></i> Add User
            </button>
          </div>
        `;
      }
      
      html += `
          </div>
          
          <div style="margin-top: 0.75rem; display: flex; gap: 0.5rem;">
            <button class="btn btn-sm btn-secondary" 
              onclick="showAddUserToProfile(${profile.id}, ${account.id})">
              <i class="fas fa-user-plus"></i> Add User
            </button>
            <button class="btn btn-sm btn-secondary" onclick="editProfile(${profile.id})">
              <i class="fas fa-edit"></i>
            </button>
          </div>
        </div>
      `;
    });
    
    // Show empty profile slots (up to 5)
    for (let i = accountProfiles.length + 1; i <= 5; i++) {
      html += `
        <div class="profile-card" style="
          background: var(--pastel-gray); border-radius: 12px; padding: 1rem; 
          border: 1px dashed var(--pastel-pink); text-align: center;">
          <div style="margin-bottom: 0.5rem;">
            <i class="fas fa-plus-circle" style="font-size: 2rem; color: var(--text-light);"></i>
          </div>
          <strong>Profile ${i}</strong>
          <div style="font-size: 0.8rem; color: var(--text-light); margin-top: 0.25rem;">
            Not created yet
          </div>
          <button class="btn btn-sm btn-secondary" 
            onclick="createProfile(${account.id}, ${i})"
            style="margin-top: 0.75rem;">
            <i class="fas fa-plus"></i> Create Profile
          </button>
        </div>
      `;
    }
    
    html += `
          </div>
        </div>
      </div>
    `;
  });
  
  html += '</div>';
  accountsList.innerHTML = html;
  // Force collapsed by default (mobile-safe)
  document.querySelectorAll('.netflix-account-card').forEach(card => {
    card.classList.add('collapsed');
    if (typeof setNetflixCardCollapsed === 'function') setNetflixCardCollapsed(card, true);
  });

}

// Filter Netflix accounts
function filterNetflixAccounts() {
  const searchTerm = document.getElementById('netflix-search')?.value.toLowerCase() || '';
  const statusFilter = document.getElementById('netflix-status-filter')?.value || 'all';
  
  // We'll need to re-render based on filters
  // For now, just implement search - you can enhance this further
  const filteredAccounts = netflixAccounts.filter(account => {
    // Search by email
    if (searchTerm && !account.email.toLowerCase().includes(searchTerm)) {
      return false;
    }
    
    // Filter by status
    if (statusFilter !== 'all') {
      if (statusFilter === 'active' && !account.is_active) return false;
      if (statusFilter === 'inactive' && account.is_active) return false;
      // Additional status filters can be implemented here
    }
    
    return true;
  });
  
  // You can implement a more sophisticated filter here
  // For simplicity, we'll just show all for now
}

// Show add Netflix account modal
function showAddNetflixAccount() {
  const modal = document.getElementById('netflix-account-modal');
  const title = document.getElementById('netflix-modal-title');
  const form = document.getElementById('netflixAccountForm');
  
  if (modal && title && form) {
    title.textContent = 'Add Netflix Account';
    form.reset();
    document.getElementById('netflix-account-id').value = '';
    document.getElementById('auto-create-profiles').checked = true;
    modal.style.display = 'block';
    modal.scrollIntoView({ behavior: 'smooth' });
  }
}

// Edit Netflix account
async function editNetflixAccount(accountId) {
  try {
    const { data: account, error } = await supabaseClient
      .from('netflix_accounts')
      .select('*')
      .eq('id', accountId)
      .single();

    if (error) throw error;
    
    const modal = document.getElementById('netflix-account-modal');
    const title = document.getElementById('netflix-modal-title');
    
    if (modal && title) {
      title.textContent = 'Edit Netflix Account';
      document.getElementById('netflix-account-id').value = account.id;
      document.getElementById('netflix-email').value = account.email;
      document.getElementById('netflix-password').value = account.password;
      document.getElementById('netflix-notes').value = account.notes || '';
      document.getElementById('netflix-is-active').value = account.is_active.toString();
      document.getElementById('auto-create-profiles').checked = false;
      
      modal.style.display = 'block';
      modal.scrollIntoView({ behavior: 'smooth' });
    }
  } catch (error) {
    console.error('Error loading Netflix account for edit:', error);
    showMessage('netflix-account-msg', 'Error loading account', 'error');
  }
}

// Save Netflix account
async function saveNetflixAccount(e) {
  e.preventDefault();
  showMessage('netflix-account-msg', 'Saving Netflix account...', 'info');

  const accountId = document.getElementById('netflix-account-id').value;
  const email = document.getElementById('netflix-email').value.trim();
  const password = document.getElementById('netflix-password').value.trim();
  const notes = document.getElementById('netflix-notes').value.trim() || null;
  const isActive = document.getElementById('netflix-is-active').value === 'true';
  const autoCreateProfiles = document.getElementById('auto-create-profiles').checked;

  if (!email || !password) {
    showMessage('netflix-account-msg', 'Email and password are required', 'error');
    return;
  }

  try {
    let accountData = {
      email,
      password,
      notes,
      is_active: isActive
    };

    let error;
    if (accountId) {
      // Update existing account
      const res = await supabaseClient
        .from('netflix_accounts')
        .update(accountData)
        .eq('id', accountId);
      error = res.error;
    } else {
      // Create new account
      const res = await supabaseClient
        .from('netflix_accounts')
        .insert([accountData]);
      error = res.error;
      
      // If auto-create profiles is checked and account was created successfully
      if (!error && autoCreateProfiles && res.data && res.data[0]) {
        const newAccountId = res.data[0].id;
        await createDefaultProfiles(newAccountId);
      }
    }

    if (error) throw error;

    showMessage('netflix-account-msg', 'Netflix account saved successfully', 'success');
    
    // Reload accounts and close modal after delay
    setTimeout(() => {
      closeNetflixModal();
      loadNetflixAccounts();
    }, 1500);
  } catch (error) {
    console.error('Error saving Netflix account:', error);
    showMessage('netflix-account-msg', 'Error saving Netflix account', 'error');
  }
}

// Create default profiles (1-5)
async function createDefaultProfiles(accountId) {
  try {
    const profiles = [];
    for (let i = 1; i <= 5; i++) {
      profiles.push({
        netflix_account_id: accountId,
        profile_number: i,
        profile_name: `Profile ${i}`,
        alias: null
      });
    }
    
    const { error } = await supabaseClient
      .from('netflix_profiles')
      .insert(profiles);
    
    if (error) throw error;
  } catch (error) {
    console.error('Error creating default profiles:', error);
  }
}

// Create individual profile
async function createProfile(accountId, profileNumber) {
  try {
    const { error } = await supabaseClient
      .from('netflix_profiles')
      .insert({
        netflix_account_id: accountId,
        profile_number: profileNumber,
        profile_name: `Profile ${profileNumber}`,
        alias: null
      });

    if (error) throw error;
    
    showMessage('netflix-account-msg', 'Profile created successfully', 'success');
    loadNetflixAccounts();
  } catch (error) {
    console.error('Error creating profile:', error);
    showMessage('netflix-account-msg', 'Error creating profile', 'error');
  }
}

// Edit profile
async function editProfile(profileId) {
  // You can implement a modal for editing profile name/alias
  const newAlias = prompt('Enter new alias for this profile (leave empty for default):');
  if (newAlias === null) return;
  
  try {
    const { error } = await supabaseClient
      .from('netflix_profiles')
      .update({ 
        alias: newAlias.trim() || null,
        profile_name: newAlias.trim() || `Profile ${profileId}`
      })
      .eq('id', profileId);

    if (error) throw error;
    
    showMessage('netflix-account-msg', 'Profile updated successfully', 'success');
    loadNetflixAccounts();
  } catch (error) {
    console.error('Error updating profile:', error);
    showMessage('netflix-account-msg', 'Error updating profile', 'error');
  }
}

// Show add user to profile modal
async function showAddUserToProfile(profileId, accountId) {
  const modal = document.getElementById('netflix-add-user-modal');
  const profileInfo = document.getElementById('adduser-profile-info');
  const saleRecordSelect = document.getElementById('adduser-sale-record');
  
  if (!modal || !profileInfo) return;
  
  try {
    // Get profile info
    const { data: profile, error } = await supabaseClient
      .from('netflix_profiles')
      .select('*')
      .eq('id', profileId)
      .single();

    if (error) throw error;
    
    // Populate profile info
    const profileAlias = profile.alias || `Profile ${profile.profile_number}`;
    profileInfo.value = profileAlias;
    document.getElementById('adduser-profile-id').value = profileId;
    document.getElementById('adduser-account-id').value = accountId;
    
    // Populate sale records dropdown
    await populateSaleRecordsDropdown();
    
    // Set default expiry date (30 days from now)
    const today = new Date();
    const expiryDate = new Date(today);
    expiryDate.setDate(expiryDate.getDate() + 30);
    
    document.getElementById('adduser-date-availed').value = today.toISOString().split('T')[0];
    document.getElementById('adduser-expiry-date').value = expiryDate.toISOString().split('T')[0];
    
    // Show modal
    modal.style.display = 'block';
    modal.scrollIntoView({ behavior: 'smooth' });
  } catch (error) {
    console.error('Error loading profile:', error);
    showMessage('netflix-adduser-msg', 'Error loading profile', 'error');
  }
}

// Populate sale records dropdown
async function populateSaleRecordsDropdown() {
  const select = document.getElementById('adduser-sale-record');
  if (!select) return;
  
  select.innerHTML = '<option value="">-- Select sale record --</option>';
  
  try {
    // Get manual records
    const { data: manualRecords, error: manualError } = await supabaseClient
      .from('manual_stock_records')
      .select('id, buyer_name, product_name, date_availed')
      .order('date_availed', { ascending: false })
      .limit(50);

    if (!manualError && manualRecords) {
      manualRecords.forEach(record => {
        const option = document.createElement('option');
        option.value = `manual_${record.id}`;
        option.textContent = `[Manual] ${record.buyer_name} - ${record.product_name} (${new Date(record.date_availed).toLocaleDateString()})`;
        select.appendChild(option);
      });
    }
    
    // Get auto records
    const { data: autoRecords, error: autoError } = await supabaseClient
      .from('product_plan_stocks')
      .select('id, email, used_at')
      .eq('is_used', true)
      .order('used_at', { ascending: false })
      .limit(50);

    if (!autoError && autoRecords) {
      autoRecords.forEach(record => {
        const option = document.createElement('option');
        option.value = `auto_${record.id}`;
        option.textContent = `[Auto] ${record.email} (${new Date(record.used_at).toLocaleDateString()})`;
        select.appendChild(option);
      });
    }
  } catch (error) {
    console.error('Error loading sale records:', error);
  }
}

// Add user to profile
async function addUserToProfile(e) {
  e.preventDefault();
  showMessage('netflix-adduser-msg', 'Adding user to profile...', 'info');

  const profileId = document.getElementById('adduser-profile-id').value;
  const buyerName = document.getElementById('adduser-buyer-name').value.trim();
  const buyerTg = document.getElementById('adduser-buyer-tg').value.trim() || null;
  const saleRecord = document.getElementById('adduser-sale-record').value;
  const dateAvailed = document.getElementById('adduser-date-availed').value;
  const expiryDate = document.getElementById('adduser-expiry-date').value;

  if (!buyerName || !dateAvailed || !expiryDate) {
    showMessage('netflix-adduser-msg', 'Please fill in all required fields', 'error');
    return;
  }

  try {
    let saleRecordId = null;
    let saleType = null;
    
    if (saleRecord) {
      const [type, id] = saleRecord.split('_');
      saleRecordId = parseInt(id);
      saleType = type;
    }

    const { error } = await supabaseClient
      .from('netflix_profile_users')
      .insert({
        profile_id: parseInt(profileId),
        buyer_name: buyerName,
        buyer_telegram_id: buyerTg,
        sale_record_id: saleRecordId,
        sale_type: saleType,
        date_availed: dateAvailed,
        expiry_date: expiryDate
      });

    if (error) throw error;

    showMessage('netflix-adduser-msg', 'User added to profile successfully', 'success');
    
    // Reset form and reload
    setTimeout(() => {
      closeAddUserModal();
      loadNetflixAccounts();
    }, 1500);
  } catch (error) {
    console.error('Error adding user to profile:', error);
    showMessage('netflix-adduser-msg', 'Error adding user to profile', 'error');
  }
  let selectedRecord = document.getElementById("adduser-sale-record").value;

if (selectedRecord) {
    const [type, id] = selectedRecord.split("_");
    payload.sale_record_id = Number(id);
    payload.sale_record_type = type.toUpperCase(); // MANUAL or AUTO
}

}

// Remove user from profile
async function removeProfileUser(userId) {
  if (!confirm('Are you sure you want to remove this user from the profile?')) return;

  try {
    const { error } = await supabaseClient
      .from('netflix_profile_users')
      .delete()
      .eq('id', userId);

    if (error) throw error;

    showMessage('netflix-account-msg', 'User removed from profile', 'success');
    loadNetflixAccounts();
  } catch (error) {
    console.error('Error removing user:', error);
    showMessage('netflix-account-msg', 'Error removing user', 'error');
  }
}

// Delete Netflix account
async function deleteNetflixAccount(accountId) {
  if (!confirm('Are you sure you want to delete this Netflix account? This will also delete all profiles and users.')) return;

  try {
    const { error } = await supabaseClient
      .from('netflix_accounts')
      .delete()
      .eq('id', accountId);

    if (error) throw error;

    showMessage('netflix-account-msg', 'Netflix account deleted successfully', 'success');
    loadNetflixAccounts();
  } catch (error) {
    console.error('Error deleting Netflix account:', error);
    showMessage('netflix-account-msg', 'Error deleting Netflix account', 'error');
  }
}

// Close modals
function closeNetflixModal() {
  const modal = document.getElementById('netflix-account-modal');
  if (modal) modal.style.display = 'none';
  document.getElementById('netflix-account-msg').innerHTML = '';
}

function closeAddUserModal() {
  const modal = document.getElementById('netflix-add-user-modal');
  if (modal) modal.style.display = 'none';
  document.getElementById('netflix-adduser-msg').innerHTML = '';
}

// Show add user to account (let user choose profile)
async function showAddUserToAccount(accountId) {
  try {
    // Get profiles for this account
    const { data: profiles, error } = await supabaseClient
      .from('netflix_profiles')
      .select('id, profile_number, alias')
      .eq('netflix_account_id', accountId)
      .order('profile_number', { ascending: true });

    if (error) throw error;

    if (!profiles || profiles.length === 0) {
      showMessage('netflix-account-msg', 'No profiles found for this account. Create profiles first.', 'error');
      return;
    }

    // Create a modal to select profile
    let profileOptions = '';
    profiles.forEach(profile => {
      const alias = profile.alias || `Profile ${profile.profile_number}`;
      profileOptions += `<option value="${profile.id}">${alias}</option>`;
    });

    const profileId = prompt(`Select profile:\n\n${profileOptions}\n\nEnter profile ID:`);
    if (!profileId) return;

    showAddUserToProfile(parseInt(profileId), accountId);
  } catch (error) {
    console.error('Error loading profiles:', error);
    showMessage('netflix-account-msg', 'Error loading profiles', 'error');
  }
}

// Load panel data for Netflix management
function loadPanelData(panelId) {
  switch(panelId) {
    // ... existing cases ...
    case 'netflix-management-panel':
      loadNetflixAccounts();
      break;
    // ... existing cases ...
  }
}

// Setup form handlers for Netflix
function setupFormHandlers() {
  // ... existing form handlers ...
  
  // Netflix account form
  const netflixAccountForm = document.getElementById('netflixAccountForm');
  if (netflixAccountForm) {
    netflixAccountForm.addEventListener('submit', saveNetflixAccount);
  }
  
  // Netflix add user form
  const netflixAddUserForm = document.getElementById('netflixAddUserForm');
  if (netflixAddUserForm) {
    netflixAddUserForm.addEventListener('submit', addUserToProfile);
  }
  
  // ... existing form handlers ...
}
document.getElementById("adduser-sale-record").onchange = async function () {
    const value = this.value;
    if (!value) return;

    const [type, id] = value.split("_");

    if (type === "manual") {
        const { data } = await supabaseClient
            .from("manual_stock_records")
            .select("*")
            .eq("id", id)
            .single();

        if (!data) return;

        showDetailOverlay(`
            <h3>Manual Record</h3>

            <div><strong>Buyer:</strong> ${data.buyer_name}</div>
            <div><strong>Product:</strong> ${data.product_name}</div>
            <div><strong>Plan:</strong> ${data.plan_type} ${data.duration}</div>
            <div><strong>Email:</strong> ${data.account_email}</div>
            <div><strong>Date Availed:</strong> ${data.date_availed}</div>
            <div><strong>Expiry:</strong> ${data.new_expiry}</div>

            <button class="btn btn-primary" onclick='applyRecordToAddUser(${JSON.stringify(data).replace(/'/g,"&#39;")})'>
                <i class="fas fa-check"></i> Use This Record
            </button>

            <button class="btn btn-secondary" onclick="closeDetailOverlay()">
                Close
            </button>
        `);
    }
};

function applyRecordToAddUser(r) {

    document.getElementById("adduser-buyer-name").value = r.buyer_name || "";
    document.getElementById("adduser-buyer-tg").value = r.buyer_telegram_id || "";

    document.getElementById("adduser-date-availed").value = r.date_availed;
    document.getElementById("adduser-expiry-date").value = r.new_expiry;

    // Lock values
    document.getElementById("adduser-date-availed").readOnly = true;
    document.getElementById("adduser-expiry-date").readOnly = true;

    closeDetailOverlay();

    alert("Record applied. Fields updated.");
}

function setNetflixCardCollapsed(card, collapsed) {
  if (!card) return;
  const show = !collapsed;
  const info = card.querySelector('.netflix-account-info');
  const actions = card.querySelector('.netflix-account-actions');
  const profiles = card.querySelector('.netflix-profiles-section');
  const notes = card.querySelector('.netflix-notes-section');

  if (info) info.style.display = show ? 'flex' : 'none';
  if (actions) actions.style.display = show ? 'flex' : 'none';
  if (profiles) profiles.style.display = show ? 'block' : 'none';
  if (notes) notes.style.display = show ? 'block' : 'none';
}

function toggleNetflixAccount(id) {
  const card = document.getElementById(`netflix-card-${id}`);
  if (!card) return;
  card.classList.toggle('collapsed');
  setNetflixCardCollapsed(card, card.classList.contains('collapsed'));
}



// Expose functions to global scope
window.loadNetflixAccounts = loadNetflixAccounts;
window.showAddNetflixAccount = showAddNetflixAccount;
window.editNetflixAccount = editNetflixAccount;
window.closeNetflixModal = closeNetflixModal;
window.closeAddUserModal = closeAddUserModal;
window.createProfile = createProfile;
window.editProfile = editProfile;
window.showAddUserToProfile = showAddUserToProfile;
window.showAddUserToAccount = showAddUserToAccount;
window.removeProfileUser = removeProfileUser;
window.deleteNetflixAccount = deleteNetflixAccount;
window.filterNetflixAccounts = filterNetflixAccounts;
  // ---------- Initialize Manual Expiry Calculator ----------
  document.addEventListener('DOMContentLoaded', function() {
    // Initialize expiry calculator when manual form is loaded
    const manualForm = document.getElementById('manualRecordForm');
    if (manualForm) {
      setTimeout(initManualExpiryCalculator, 500);
    }
  });

  // Expose functions to global scope
  window.toggleProductGroup = function(productId) {
    const body = document.getElementById(`product-body-${productId}`);
    if (body) {
      body.classList.toggle('open');
    }
  };
  window.startEditStockGroup = startEditStockGroup;
  window.deleteStockGroup = deleteStockGroup;
  window.cancelEditStock = cancelEditStock;
  window.editManualRecord = editManualRecord;
  window.deleteManualRecord = deleteManualRecord;
  window.startAutoExpiryEdit = startAutoExpiryEdit;
  window.calculateAutoExpiry = calculateAutoExpiry;
  window.saveAutoExpiry = saveAutoExpiry;
  window.cancelAutoExpiry = cancelAutoExpiry;
  window.editRule = editRule;
  window.deleteRule = deleteRule;
  window.downloadRecordsCsv = downloadRecordsCsv;
  window.refreshDashboard = refreshDashboard;
  window.loadRecordsAll = loadRecordsAll;
  window.loadRecordsAuto = loadRecordsAuto;
  window.loadRecordsManual = loadRecordsManual;
  window.loadManageStocks = loadManageStocks;
  window.loadRulesList = loadRulesList;
  window.loadSoldStocks = loadSoldStocks;
  window.showSoldDetails = showSoldDetails;
  window.populateManualDropdowns = populateManualDropdowns;
  window.populateAddStockDropdowns = populateAddStockDropdowns;
  window.toggleSidebar = toggleSidebar;
  window.closeSidebar = closeSidebar;
  window.closeDetailOverlay = closeDetailOverlay;
</script>
</body>
</html>